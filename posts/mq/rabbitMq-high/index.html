<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>RabbitMq高级特性 | Cx`s Blog</title><meta name="author" content="Cx"><meta name="copyright" content="Cx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="RabbitMQ 高级特性 - 可靠性与延迟消息前言在分布式系统中，消息队列扮演着重要角色。但是，如何确保消息的可靠性传递是一个关键问题。 真实业务场景考虑一个电商支付场景：  用户完成支付 → 支付服务记录支付成功 支付服务通过MQ通知交易服务 → 更新订单状态为已支付 如果MQ通知失败会怎样？ 支付服务：支付成功 ✅ 交易服务：订单未支付 ❌ 用户体验：明明支付了，为什么显示未支付？😰">
<meta property="og:type" content="article">
<meta property="og:title" content="RabbitMq高级特性">
<meta property="og:url" content="https://cxhahalala.github.io/posts/mq/rabbitMq-high/index.html">
<meta property="og:site_name" content="Cx&#96;s Blog">
<meta property="og:description" content="RabbitMQ 高级特性 - 可靠性与延迟消息前言在分布式系统中，消息队列扮演着重要角色。但是，如何确保消息的可靠性传递是一个关键问题。 真实业务场景考虑一个电商支付场景：  用户完成支付 → 支付服务记录支付成功 支付服务通过MQ通知交易服务 → 更新订单状态为已支付 如果MQ通知失败会怎样？ 支付服务：支付成功 ✅ 交易服务：订单未支付 ❌ 用户体验：明明支付了，为什么显示未支付？😰">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://w.wallhaven.cc/full/je/wallhaven-je8q9w.jpg">
<meta property="article:published_time" content="2025-07-17T08:42:08.000Z">
<meta property="article:modified_time" content="2025-07-17T09:38:12.541Z">
<meta property="article:author" content="Cx">
<meta property="article:tag" content="RabbitMQ">
<meta property="article:tag" content="消息队列">
<meta property="article:tag" content="Spring AMQP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://w.wallhaven.cc/full/je/wallhaven-je8q9w.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "RabbitMq高级特性",
  "url": "https://cxhahalala.github.io/posts/mq/rabbitMq-high/",
  "image": "https://w.wallhaven.cc/full/je/wallhaven-je8q9w.jpg",
  "datePublished": "2025-07-17T08:42:08.000Z",
  "dateModified": "2025-07-17T09:38:12.541Z",
  "author": [
    {
      "@type": "Person",
      "name": "Cx",
      "url": "https://cxhahalala.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://cxhahalala.github.io/posts/mq/rabbitMq-high/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'RabbitMq高级特性',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/Background/%E5%A4%B4%E5%83%8F1.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">9</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/photo/"><i class="fa-fw fas fa-camera"></i><span> 图片</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://w.wallhaven.cc/full/je/wallhaven-je8q9w.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Cx`s Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">RabbitMq高级特性</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/photo/"><i class="fa-fw fas fa-camera"></i><span> 图片</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">RabbitMq高级特性</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-07-17T08:42:08.000Z" title="发表于 2025-07-17 16:42:08">2025-07-17</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-07-17T09:38:12.541Z" title="更新于 2025-07-17 17:38:12">2025-07-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="RabbitMQ-高级特性-可靠性与延迟消息"><a href="#RabbitMQ-高级特性-可靠性与延迟消息" class="headerlink" title="RabbitMQ 高级特性 - 可靠性与延迟消息"></a>RabbitMQ 高级特性 - 可靠性与延迟消息</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在分布式系统中，消息队列扮演着重要角色。但是，如何确保消息的可靠性传递是一个关键问题。</p>
<h3 id="真实业务场景"><a href="#真实业务场景" class="headerlink" title="真实业务场景"></a>真实业务场景</h3><p>考虑一个电商支付场景：</p>
<ol>
<li>用户完成支付 → 支付服务记录支付成功</li>
<li>支付服务通过MQ通知交易服务 → 更新订单状态为已支付</li>
<li><strong>如果MQ通知失败会怎样？</strong><ul>
<li>支付服务：支付成功 ✅</li>
<li>交易服务：订单未支付 ❌</li>
<li>用户体验：明明支付了，为什么显示未支付？😰</li>
</ul>
</li>
</ol>
<h3 id="核心问题"><a href="#核心问题" class="headerlink" title="核心问题"></a>核心问题</h3><ul>
<li><strong>如何确保MQ消息的可靠性传递？</strong></li>
<li><strong>消息丢失时有什么兜底方案？</strong></li>
<li><strong>如何处理延迟任务（如订单超时取消）？</strong></li>
</ul>
<p>让我们一步步解决这些问题。</p>
<h1 id="1-发送者的可靠性"><a href="#1-发送者的可靠性" class="headerlink" title="1. 发送者的可靠性"></a>1. 发送者的可靠性</h1><blockquote>
<p><strong>目标：确保生产者一定把消息发送到MQ</strong></p>
</blockquote>
<p><strong>原则：消息应该至少被消费者处理1次</strong></p>
<h2 id="1-1-消息丢失的可能性分析"><a href="#1-1-消息丢失的可能性分析" class="headerlink" title="1.1 消息丢失的可能性分析"></a>1.1 消息丢失的可能性分析</h2><p>消息从发送者到消费者的传递路径：<br><img src="https://cdn.jsdelivr.net/gh/Cxhahalala/hexo-images-1@main/images/20250717172314987.png"></p>
<h3 id="🔍-消息丢失的三大环节"><a href="#🔍-消息丢失的三大环节" class="headerlink" title="🔍 消息丢失的三大环节"></a>🔍 消息丢失的三大环节</h3><h4 id="1️⃣-发送阶段丢失"><a href="#1️⃣-发送阶段丢失" class="headerlink" title="1️⃣ 发送阶段丢失"></a>1️⃣ 发送阶段丢失</h4><ul>
<li><strong>网络故障</strong>：生产者发送消息时连接MQ失败</li>
<li><strong>交换机不存在</strong>：发送到不存在的Exchange</li>
<li><strong>路由失败</strong>：Exchange找不到合适的Queue</li>
<li><strong>MQ内部异常</strong>：消息到达MQ后处理进程异常</li>
</ul>
<h4 id="2️⃣-MQ存储阶段丢失"><a href="#2️⃣-MQ存储阶段丢失" class="headerlink" title="2️⃣ MQ存储阶段丢失"></a>2️⃣ MQ存储阶段丢失</h4><ul>
<li><strong>宕机丢失</strong>：消息到达MQ，保存到队列后突然宕机</li>
<li><strong>内存丢失</strong>：消息只在内存中，未持久化</li>
</ul>
<h4 id="3️⃣-消费阶段丢失"><a href="#3️⃣-消费阶段丢失" class="headerlink" title="3️⃣ 消费阶段丢失"></a>3️⃣ 消费阶段丢失</h4><ul>
<li><strong>消费者宕机</strong>：消息接收后尚未处理就宕机</li>
<li><strong>处理异常</strong>：消息处理过程中抛出异常</li>
</ul>
<h3 id="📋-解决方案概览"><a href="#📋-解决方案概览" class="headerlink" title="📋 解决方案概览"></a>📋 解决方案概览</h3><table>
<thead>
<tr>
<th>阶段</th>
<th>问题</th>
<th>解决方案</th>
</tr>
</thead>
<tbody><tr>
<td><strong>发送阶段</strong></td>
<td>网络故障、路由失败</td>
<td>重试机制 + 生产者确认</td>
</tr>
<tr>
<td><strong>存储阶段</strong></td>
<td>MQ宕机、内存丢失</td>
<td>数据持久化 + LazyQueue</td>
</tr>
<tr>
<td><strong>消费阶段</strong></td>
<td>消费者故障</td>
<td>消费者确认 + 失败重试</td>
</tr>
</tbody></table>
<h2 id="1-2-生产者重试机制"><a href="#1-2-生产者重试机制" class="headerlink" title="1.2 生产者重试机制"></a>1.2 生产者重试机制</h2><h3 id="🎯-适用场景"><a href="#🎯-适用场景" class="headerlink" title="🎯 适用场景"></a>🎯 适用场景</h3><p>网络不稳定导致与MQ连接中断时，自动重试发送消息。</p>
<h3 id="⚙️-配置方式"><a href="#⚙️-配置方式" class="headerlink" title="⚙️ 配置方式"></a>⚙️ 配置方式</h3><p>修改<code>publisher</code>模块的<code>application.yaml</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">connection-timeout:</span> <span class="string">1s</span> <span class="comment"># 设置MQ的连接超时时间</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">retry:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启超时重试机制</span></span><br><span class="line">        <span class="attr">initial-interval:</span> <span class="string">1000ms</span> <span class="comment"># 失败后的初始等待时间</span></span><br><span class="line">        <span class="attr">multiplier:</span> <span class="number">1</span> <span class="comment"># 失败后下次的等待时长倍数，下次等待时长 = initial-interval * multiplier</span></span><br><span class="line">        <span class="attr">max-attempts:</span> <span class="number">3</span> <span class="comment"># 最大重试次数</span></span><br></pre></td></tr></table></figure>

<h3 id="🧪-测试效果"><a href="#🧪-测试效果" class="headerlink" title="🧪 测试效果"></a>🧪 测试效果</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停掉RabbitMQ服务</span></span><br><span class="line">docker stop mq</span><br></pre></td></tr></table></figure>
<p>发送消息后会看到：每隔1秒重试1次，总共重试3次。</p>
<h3 id="⚠️-注意事项"><a href="#⚠️-注意事项" class="headerlink" title="⚠️ 注意事项"></a>⚠️ 注意事项</h3><p><strong>SpringAMQP的重试是阻塞式的</strong></p>
<ul>
<li>重试期间当前线程被阻塞</li>
<li>对性能有要求的业务建议禁用重试</li>
<li>可考虑使用异步线程发送消息</li>
</ul>
<h3 id="💡-最佳实践"><a href="#💡-最佳实践" class="headerlink" title="💡 最佳实践"></a>💡 最佳实践</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 高性能场景配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">retry:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">false</span> <span class="comment"># 禁用重试，依赖生产者确认机制</span></span><br></pre></td></tr></table></figure>

<h2 id="1-3-生产者确认机制"><a href="#1-3-生产者确认机制" class="headerlink" title="1.3 生产者确认机制"></a>1.3 生产者确认机制</h2><h3 id="🎯-解决问题"><a href="#🎯-解决问题" class="headerlink" title="🎯 解决问题"></a>🎯 解决问题</h3><p>即使网络正常，消息也可能在MQ内部丢失：</p>
<ul>
<li>MQ内部处理进程异常</li>
<li>Exchange不存在</li>
<li>Queue不存在，无法路由</li>
</ul>
<h3 id="📋-确认机制类型"><a href="#📋-确认机制类型" class="headerlink" title="📋 确认机制类型"></a>📋 确认机制类型</h3><p>RabbitMQ提供了<strong>生产者消息确认机制</strong>：</p>
<table>
<thead>
<tr>
<th>确认类型</th>
<th>触发时机</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Publisher Confirm</strong></td>
<td>消息到达Exchange</td>
<td>确认消息是否成功到达RabbitMQ</td>
</tr>
<tr>
<td><strong>Publisher Return</strong></td>
<td>消息路由失败</td>
<td>确认消息是否成功路由到Queue</td>
</tr>
</tbody></table>
<h3 id="🔄-工作流程"><a href="#🔄-工作流程" class="headerlink" title="🔄 工作流程"></a>🔄 工作流程</h3><p><img src="https://cdn.jsdelivr.net/gh/Cxhahalala/hexo-images-1@main/images/20250717171829914.png"></p>
<h4 id="场景分析"><a href="#场景分析" class="headerlink" title="场景分析"></a>场景分析</h4><ol>
<li><strong>正常情况</strong>：消息到达Exchange且成功路由 → 只收到 Confirm(ack)</li>
<li><strong>Exchange错误</strong>：Exchange不存在 → 收到 Confirm(nack) </li>
<li><strong>路由失败</strong>：Exchange存在但Queue不存在 → 收到 Confirm(ack) + Return</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/Cxhahalala/hexo-images-1@main/images/20250716200552479.png"></p>
<h2 id="1-4-实现生产者确认"><a href="#1-4-实现生产者确认" class="headerlink" title="1.4 实现生产者确认"></a>1.4 实现生产者确认</h2><h3 id="1-4-1-开启生产者确认"><a href="#1-4-1-开启生产者确认" class="headerlink" title="1.4.1 开启生产者确认"></a>1.4.1 开启生产者确认</h3><p>在publisher模块的<code>application.yaml</code>中添加配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">publisher-confirm-type:</span> <span class="string">correlated</span> <span class="comment"># 开启publisher confirm机制，并设置confirm类型</span></span><br><span class="line">    <span class="attr">publisher-returns:</span> <span class="literal">true</span> <span class="comment"># 开启publisher return机制</span></span><br></pre></td></tr></table></figure>

<h4 id="📋-confirm类型说明"><a href="#📋-confirm类型说明" class="headerlink" title="📋 confirm类型说明"></a>📋 confirm类型说明</h4><table>
<thead>
<tr>
<th>模式</th>
<th>说明</th>
<th>使用场景</th>
</tr>
</thead>
<tbody><tr>
<td><code>none</code></td>
<td>关闭confirm机制</td>
<td>性能要求极高，容忍少量消息丢失</td>
</tr>
<tr>
<td><code>simple</code></td>
<td>同步阻塞等待MQ回执</td>
<td>简单场景，性能要求不高</td>
</tr>
<tr>
<td><code>correlated</code></td>
<td>MQ异步回调返回回执</td>
<td><strong>推荐</strong>，性能好且可靠</td>
</tr>
</tbody></table>
<h3 id="1-4-2-定义ReturnCallback"><a href="#1-4-2-定义ReturnCallback" class="headerlink" title="1.4.2 定义ReturnCallback"></a>1.4.2 定义ReturnCallback</h3><blockquote>
<p><strong>ReturnCallback</strong>：全局唯一，统一处理路由失败的消息</p>
</blockquote>
<p>创建配置类 <code>com.itheima.publisher.config.MqConfig</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">        rabbitTemplate.setReturnsCallback(<span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>.ReturnsCallback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(ReturnedMessage returned)</span> &#123;</span><br><span class="line">                log.error(<span class="string">&quot;触发return callback,&quot;</span>);</span><br><span class="line">                log.debug(<span class="string">&quot;exchange: &#123;&#125;&quot;</span>, returned.getExchange());</span><br><span class="line">                log.debug(<span class="string">&quot;routingKey: &#123;&#125;&quot;</span>, returned.getRoutingKey());</span><br><span class="line">                log.debug(<span class="string">&quot;message: &#123;&#125;&quot;</span>, returned.getMessage());</span><br><span class="line">                log.debug(<span class="string">&quot;replyCode: &#123;&#125;&quot;</span>, returned.getReplyCode());</span><br><span class="line">                log.debug(<span class="string">&quot;replyText: &#123;&#125;&quot;</span>, returned.getReplyText());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-4-3-定义ConfirmCallback"><a href="#1-4-3-定义ConfirmCallback" class="headerlink" title="1.4.3 定义ConfirmCallback"></a>1.4.3 定义ConfirmCallback</h3><blockquote>
<p><strong>ConfirmCallback</strong>：每次发送消息时单独定义，处理具体业务逻辑</p>
</blockquote>
<h4 id="💡-使用CorrelationData"><a href="#💡-使用CorrelationData" class="headerlink" title="💡 使用CorrelationData"></a>💡 使用CorrelationData</h4><p><img src="https://cdn.jsdelivr.net/gh/Cxhahalala/hexo-images-1@main/images/20250717171901262.png"></p>
<p><strong>CorrelationData核心内容</strong>：</p>
<ul>
<li><code>id</code>：消息的唯一标识，避免回执混淆</li>
<li><code>future</code>：CompletableFuture对象，接收回执结果</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Cxhahalala/hexo-images-1@main/images/20250716201120297.png"></p>
<h4 id="📝-代码示例"><a href="#📝-代码示例" class="headerlink" title="📝 代码示例"></a>📝 代码示例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPublisherConfirm</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">CorrelationData</span> <span class="variable">correlationData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorrelationData</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加回调处理</span></span><br><span class="line">    correlationData.getFuture()</span><br><span class="line">        .thenAccept(confirm -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span>(confirm.isAck())&#123;</span><br><span class="line">                log.info(<span class="string">&quot;消息发送成功,收到Ack&quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                log.info(<span class="string">&quot;消息发送失败,原因 &#123;&#125;,id &#123;&#125;&quot;</span>,confirm.getReason(),correlationData.getId());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        .exceptionally(throwable -&gt; &#123;</span><br><span class="line">            log.error(<span class="string">&quot;消息发送失败,原因 &#123;&#125;&quot;</span>,throwable.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;cx.direct&quot;</span>, <span class="string">&quot;yell&quot;</span>, <span class="string">&quot;hello,confirm&quot;</span>, correlationData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="🧪-测试结果"><a href="#🧪-测试结果" class="headerlink" title="🧪 测试结果"></a>🧪 测试结果</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">07-16 20:12:50:726 ERROR 11904 --- [nectionFactory2] com.itheima.publisher.config.MqConfig    : 触发return callback,</span><br><span class="line">07-16 20:12:50:726  INFO 11904 --- [ 127.0.0.1:5672] c.i.publisher.PublisherApplicationTest   : 消息发送成功,收到Ack</span><br></pre></td></tr></table></figure>

<h3 id="📊-结果分析"><a href="#📊-结果分析" class="headerlink" title="📊 结果分析"></a>📊 结果分析</h3><table>
<thead>
<tr>
<th>场景</th>
<th>Confirm回执</th>
<th>Return回执</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>正常发送</td>
<td>ack</td>
<td>无</td>
<td>消息成功送达并路由</td>
</tr>
<tr>
<td>RoutingKey错误</td>
<td>ack</td>
<td>触发</td>
<td>消息到达Exchange但路由失败</td>
</tr>
<tr>
<td>Exchange错误</td>
<td>nack</td>
<td>无</td>
<td>消息未到达Exchange</td>
</tr>
</tbody></table>
<h3 id="⚠️-使用建议"><a href="#⚠️-使用建议" class="headerlink" title="⚠️ 使用建议"></a>⚠️ 使用建议</h3><p>生产者确认比较消耗MQ性能，<strong>一般不建议开启</strong>。</p>
<p><strong>何时开启？</strong></p>
<ul>
<li>对消息可靠性要求<strong>极高</strong>的业务</li>
<li>大多数情况下只需开启 <strong>ConfirmCallback</strong> 处理nack</li>
</ul>
<p><strong>常见失败原因多为编程错误</strong>：</p>
<ul>
<li>RoutingKey拼写错误 </li>
<li>Exchange名称错误</li>
<li>这类问题应该在开发阶段解决</li>
</ul>
<h1 id="2-MQ的可靠性"><a href="#2-MQ的可靠性" class="headerlink" title="2. MQ的可靠性"></a>2. MQ的可靠性</h1><blockquote>
<p><strong>目标：确保MQ不会将消息弄丢</strong></p>
</blockquote>
<p>消息到达MQ后，如果MQ不能及时保存，也会导致消息丢失。因此MQ的可靠性同样重要。</p>
<h2 id="2-1-数据持久化"><a href="#2-1-数据持久化" class="headerlink" title="2.1 数据持久化"></a>2.1 数据持久化</h2><h3 id="🎯-问题分析"><a href="#🎯-问题分析" class="headerlink" title="🎯 问题分析"></a>🎯 问题分析</h3><p>默认情况下，RabbitMQ的数据存储在内存中：</p>
<ul>
<li><strong>优点</strong>：读写速度快，性能好</li>
<li><strong>缺点</strong>：重启后数据丢失</li>
</ul>
<h3 id="💾-三级持久化策略"><a href="#💾-三级持久化策略" class="headerlink" title="💾 三级持久化策略"></a>💾 三级持久化策略</h3><table>
<thead>
<tr>
<th>持久化级别</th>
<th>作用</th>
<th>重启后效果</th>
</tr>
</thead>
<tbody><tr>
<td><strong>交换机持久化</strong></td>
<td>保存交换机定义</td>
<td>交换机仍存在</td>
</tr>
<tr>
<td><strong>队列持久化</strong></td>
<td>保存队列定义</td>
<td>队列仍存在</td>
</tr>
<tr>
<td><strong>消息持久化</strong></td>
<td>保存消息内容</td>
<td>消息仍存在</td>
</tr>
</tbody></table>
<h3 id="2-1-1-交换机持久化"><a href="#2-1-1-交换机持久化" class="headerlink" title="2.1.1 交换机持久化"></a>2.1.1 交换机持久化</h3><p>在控制台的<code>Exchanges</code>页面创建交换机时：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Cxhahalala/hexo-images-1@main/images/20250716201900347.png"></p>
<ul>
<li><strong>Durable</strong>：持久化模式（推荐）</li>
<li><strong>Transient</strong>：临时模式</li>
</ul>
<h3 id="2-1-2-队列持久化"><a href="#2-1-2-队列持久化" class="headerlink" title="2.1.2 队列持久化"></a>2.1.2 队列持久化</h3><p>在控制台的<code>Queues</code>页面创建队列时：</p>
<p><img src="C:\Users\Chenxin\AppData\Roaming\Typora\typora-user-images\image-20250717171919967.png" alt="image-20250717171919967"></p>
<h3 id="2-1-3-消息持久化"><a href="#2-1-3-消息持久化" class="headerlink" title="2.1.3 消息持久化"></a>2.1.3 消息持久化</h3><p>发送消息时配置<code>properties</code>：</p>
<p><img src="C:\Users\Chenxin\AppData\Roaming\Typora\typora-user-images\image-20250716202437751.png" alt="image-20250716202437751"></p>
<h3 id="📝-代码中的持久化配置"><a href="#📝-代码中的持久化配置" class="headerlink" title="📝 代码中的持久化配置"></a>📝 代码中的持久化配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明持久化交换机</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> DirectExchange <span class="title function_">durableExchange</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ExchangeBuilder.directExchange(<span class="string">&quot;durable.exchange&quot;</span>)</span><br><span class="line">            .durable(<span class="literal">true</span>)  <span class="comment">// 持久化</span></span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 声明持久化队列</span></span><br><span class="line"><span class="meta">@Bean</span>  </span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">durableQueue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> QueueBuilder.durable(<span class="string">&quot;durable.queue&quot;</span>).build();  <span class="comment">// 持久化队列</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送持久化消息</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendDurableMessage</span><span class="params">(String message)</span> &#123;</span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;durable.exchange&quot;</span>, <span class="string">&quot;durable&quot;</span>, message, msg -&gt; &#123;</span><br><span class="line">        msg.getMessageProperties().setDeliveryMode(MessageDeliveryMode.PERSISTENT);  <span class="comment">// 消息持久化</span></span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="⚠️-重要提醒"><a href="#⚠️-重要提醒" class="headerlink" title="⚠️ 重要提醒"></a>⚠️ 重要提醒</h3><p>开启持久化机制后：</p>
<ol>
<li><strong>生产者确认延迟</strong>：MQ会在消息持久化后才发送ACK，确保可靠性</li>
<li><strong>批量持久化</strong>：为减少IO次数，消息每隔~100ms批量持久化  </li>
<li><strong>建议异步</strong>：生产者确认全部采用异步方式以提升性能</li>
</ol>
<h2 id="2-2-LazyQueue（惰性队列）"><a href="#2-2-LazyQueue（惰性队列）" class="headerlink" title="2.2 LazyQueue（惰性队列）"></a>2.2 LazyQueue（惰性队列）</h2><h3 id="🎯-背景问题"><a href="#🎯-背景问题" class="headerlink" title="🎯 背景问题"></a>🎯 背景问题</h3><p>在默认情况下，RabbitMQ将消息保存在内存中以降低延迟。但在特殊情况下会导致<strong>消息积压</strong>：</p>
<h4 id="📊-消息积压的场景"><a href="#📊-消息积压的场景" class="headerlink" title="📊 消息积压的场景"></a>📊 消息积压的场景</h4><ul>
<li><strong>消费者故障</strong>：宕机或网络故障</li>
<li><strong>流量激增</strong>：消息发送量超过消费者处理速度  </li>
<li><strong>业务阻塞</strong>：消费者处理业务发生阻塞</li>
</ul>
<h4 id="⚠️-积压的危害"><a href="#⚠️-积压的危害" class="headerlink" title="⚠️ 积压的危害"></a>⚠️ 积压的危害</h4><ol>
<li><strong>内存占用飙升</strong>：消息越积越多</li>
<li><strong>触发内存预警</strong>：达到内存上限</li>
<li><strong>PageOut阻塞</strong>：内存消息刷到磁盘，阻塞队列进程</li>
<li><strong>服务不可用</strong>：生产者请求全部被阻塞</li>
</ol>
<h3 id="💡-LazyQueue解决方案"><a href="#💡-LazyQueue解决方案" class="headerlink" title="💡 LazyQueue解决方案"></a>💡 LazyQueue解决方案</h3><p>从RabbitMQ 3.6.0开始引入惰性队列：</p>
<h4 id="🔄-工作模式对比"><a href="#🔄-工作模式对比" class="headerlink" title="🔄 工作模式对比"></a>🔄 工作模式对比</h4><table>
<thead>
<tr>
<th>特性</th>
<th>普通队列</th>
<th>LazyQueue</th>
</tr>
</thead>
<tbody><tr>
<td><strong>消息存储</strong></td>
<td>优先内存</td>
<td>直接磁盘</td>
</tr>
<tr>
<td><strong>消费方式</strong></td>
<td>内存读取</td>
<td>懒加载到内存</td>
</tr>
<tr>
<td><strong>内存占用</strong></td>
<td>高</td>
<td>低</td>
</tr>
<tr>
<td><strong>支持容量</strong></td>
<td>受内存限制</td>
<td>数百万条消息</td>
</tr>
<tr>
<td><strong>性能</strong></td>
<td>读写快</td>
<td>稍慢但稳定</td>
</tr>
</tbody></table>
<h4 id="📈-版本演进"><a href="#📈-版本演进" class="headerlink" title="📈 版本演进"></a>📈 版本演进</h4><ul>
<li><strong>3.12.0之前</strong>：需要手动开启Lazy模式</li>
<li><strong>3.12.0及以后</strong>：默认行为已类似Lazy模式，更积极地写入磁盘</li>
</ul>
<h3 id="2-2-1-控制台配置Lazy模式"><a href="#2-2-1-控制台配置Lazy模式" class="headerlink" title="2.2.1 控制台配置Lazy模式"></a>2.2.1 控制台配置Lazy模式</h3><p>创建队列时添加参数：<code>x-queue-mode=lazy</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/Cxhahalala/hexo-images-1@main/images/20250716205322020.png"></p>
<h3 id="2-2-2-代码配置Lazy模式"><a href="#2-2-2-代码配置Lazy模式" class="headerlink" title="2.2.2 代码配置Lazy模式"></a>2.2.2 代码配置Lazy模式</h3><h4 id="方式一：QueueBuilder方式"><a href="#方式一：QueueBuilder方式" class="headerlink" title="方式一：QueueBuilder方式"></a>方式一：QueueBuilder方式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">lazyQueue</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> QueueBuilder</span><br><span class="line">            .durable(<span class="string">&quot;lazy.queue&quot;</span>)</span><br><span class="line">            .lazy() <span class="comment">// 开启Lazy模式</span></span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="方式二：注解方式"><a href="#方式二：注解方式" class="headerlink" title="方式二：注解方式"></a>方式二：注解方式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queuesToDeclare = @Queue(</span></span><br><span class="line"><span class="meta">        name = &quot;lazy.queue&quot;,</span></span><br><span class="line"><span class="meta">        durable = &quot;true&quot;,</span></span><br><span class="line"><span class="meta">        arguments = @Argument(name = &quot;x-queue-mode&quot;, value = &quot;lazy&quot;)</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenLazyQueue</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;接收到 lazy.queue的消息：&#123;&#125;&quot;</span>, msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-3-更新已有队列为Lazy模式"><a href="#2-2-3-更新已有队列为Lazy模式" class="headerlink" title="2.2.3 更新已有队列为Lazy模式"></a>2.2.3 更新已有队列为Lazy模式</h3><h4 id="命令行方式"><a href="#命令行方式" class="headerlink" title="命令行方式"></a>命令行方式</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl set_policy Lazy &quot;^lazy-queue$&quot; &#x27;&#123;&quot;queue-mode&quot;:&quot;lazy&quot;&#125;&#x27; --apply-to queues  </span><br></pre></td></tr></table></figure>

<p><strong>命令解析</strong>：</p>
<ul>
<li><code>rabbitmqctl</code>：RabbitMQ命令行工具</li>
<li><code>set_policy</code>：添加策略 </li>
<li><code>Lazy</code>：策略名称（自定义）</li>
<li><code>&quot;^lazy-queue$&quot;</code>：正则匹配队列名</li>
<li><code>&#39;&#123;&quot;queue-mode&quot;:&quot;lazy&quot;&#125;&#39;</code>：设置队列模式</li>
<li><code>--apply-to queues</code>：应用到所有队列</li>
</ul>
<h4 id="控制台方式"><a href="#控制台方式" class="headerlink" title="控制台方式"></a>控制台方式</h4><p>在<code>Admin</code> → <code>Policies</code>页面添加策略：</p>
<p><img src="C:\Users\Chenxin\AppData\Roaming\Typora\typora-user-images\image-20250717171943508.png" alt="image-20250717171943508"></p>
<h3 id="🎯-使用建议"><a href="#🎯-使用建议" class="headerlink" title="🎯 使用建议"></a>🎯 使用建议</h3><h4 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h4><ul>
<li><strong>消息量大</strong>：预期消息积压较多</li>
<li><strong>消费缓慢</strong>：消费者处理速度较慢</li>
<li><strong>内存敏感</strong>：服务器内存资源有限</li>
</ul>
<h4 id="性能权衡"><a href="#性能权衡" class="headerlink" title="性能权衡"></a>性能权衡</h4><ul>
<li><strong>选择LazyQueue</strong>：稳定性 &gt; 性能</li>
<li><strong>选择普通队列</strong>：性能 &gt; 资源占用</li>
</ul>
<h1 id="3-消费者的可靠性"><a href="#3-消费者的可靠性" class="headerlink" title="3. 消费者的可靠性"></a>3. 消费者的可靠性</h1><blockquote>
<p><strong>目标：确保消费者一定要处理消息</strong></p>
</blockquote>
<p>当RabbitMQ向消费者投递消息后，需要知道消费者的处理状态。消息投递给消费者并不代表一定被正确消费，可能出现各种故障。</p>
<h3 id="🚨-常见消费故障"><a href="#🚨-常见消费故障" class="headerlink" title="🚨 常见消费故障"></a>🚨 常见消费故障</h3><table>
<thead>
<tr>
<th>故障类型</th>
<th>具体场景</th>
<th>后果</th>
</tr>
</thead>
<tbody><tr>
<td><strong>网络故障</strong></td>
<td>消息投递过程中网络中断</td>
<td>消息丢失</td>
</tr>
<tr>
<td><strong>消费者宕机</strong></td>
<td>接收消息后突然宕机</td>
<td>消息丢失</td>
</tr>
<tr>
<td><strong>处理异常</strong></td>
<td>消息处理逻辑出现bug</td>
<td>消息丢失</td>
</tr>
<tr>
<td><strong>资源不足</strong></td>
<td>内存不足、数据库连接池满</td>
<td>消息丢失</td>
</tr>
</tbody></table>
<h3 id="❓-核心问题"><a href="#❓-核心问题" class="headerlink" title="❓ 核心问题"></a>❓ 核心问题</h3><p><strong>RabbitMQ如何得知消费者的处理状态？</strong></p>
<p>答案就是：<strong>消费者确认机制</strong></p>
<h2 id="3-1-消费者确认机制"><a href="#3-1-消费者确认机制" class="headerlink" title="3.1 消费者确认机制"></a>3.1 消费者确认机制</h2><h3 id="🔄-确认机制原理"><a href="#🔄-确认机制原理" class="headerlink" title="🔄 确认机制原理"></a>🔄 确认机制原理</h3><p>消费者处理消息结束后，应该向RabbitMQ发送一个<strong>回执</strong>，告知消息处理状态。</p>
<h4 id="📋-三种回执类型"><a href="#📋-三种回执类型" class="headerlink" title="📋 三种回执类型"></a>📋 三种回执类型</h4><table>
<thead>
<tr>
<th>回执类型</th>
<th>含义</th>
<th>RabbitMQ行为</th>
</tr>
</thead>
<tbody><tr>
<td><strong>ack</strong></td>
<td>消息处理成功</td>
<td>从队列中删除消息 ✅</td>
</tr>
<tr>
<td><strong>nack</strong></td>
<td>消息处理失败</td>
<td>重新投递消息 🔄</td>
</tr>
<tr>
<td><strong>reject</strong></td>
<td>拒绝消息</td>
<td>从队列中删除消息 ❌</td>
</tr>
</tbody></table>
<h4 id="💭-使用场景"><a href="#💭-使用场景" class="headerlink" title="💭 使用场景"></a>💭 使用场景</h4><ul>
<li><strong>ack</strong>：正常处理完成</li>
<li><strong>nack</strong>：处理失败，希望重试（如临时网络问题）</li>
<li><strong>reject</strong>：消息格式错误，无需重试（如消息格式有问题）</li>
</ul>
<h3 id="⚙️-SpringAMQP的ACK处理模式"><a href="#⚙️-SpringAMQP的ACK处理模式" class="headerlink" title="⚙️ SpringAMQP的ACK处理模式"></a>⚙️ SpringAMQP的ACK处理模式</h3><p>SpringAMQP自动化了消息确认处理，提供三种模式：</p>
<h4 id="📊-模式对比"><a href="#📊-模式对比" class="headerlink" title="📊 模式对比"></a>📊 模式对比</h4><table>
<thead>
<tr>
<th>模式</th>
<th>描述</th>
<th>安全性</th>
<th>灵活性</th>
<th>推荐度</th>
</tr>
</thead>
<tbody><tr>
<td><strong>none</strong></td>
<td>消息投递后立即ack</td>
<td>❌ 很低</td>
<td>❌ 无</td>
<td>❌ 不推荐</td>
</tr>
<tr>
<td><strong>manual</strong></td>
<td>手动调用API发送ack&#x2F;nack</td>
<td>✅ 高</td>
<td>✅ 最高</td>
<td>🔶 特殊场景</td>
</tr>
<tr>
<td><strong>auto</strong></td>
<td>自动根据异常类型处理</td>
<td>✅ 高</td>
<td>🔶 中等</td>
<td>✅ <strong>推荐</strong></td>
</tr>
</tbody></table>
<h4 id="🤖-auto模式的处理逻辑"><a href="#🤖-auto模式的处理逻辑" class="headerlink" title="🤖 auto模式的处理逻辑"></a>🤖 auto模式的处理逻辑</h4><p>SpringAMQP使用AOP对消息处理逻辑做环绕增强：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">    // 业务逻辑处理</span><br><span class="line">    processMessage(message);</span><br><span class="line">    return ack;  // 成功时自动返回ack</span><br><span class="line">&#125; catch (Exception e) &#123;</span><br><span class="line">    if (isBusinessException(e)) &#123;</span><br><span class="line">        return nack;  // 业务异常，返回nack重试</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return reject;  // 消息格式异常，返回reject拒绝</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="📋-返回reject的异常类型"><a href="#📋-返回reject的异常类型" class="headerlink" title="📋 返回reject的异常类型"></a>📋 返回reject的异常类型</h4><blockquote>
<p>从SpringAMQP 1.3.2开始，默认的ErrorHandler会对以下异常返回reject：</p>
</blockquote>
<ul>
<li><code>MessageConversionException</code>：消息转换异常</li>
<li><code>MethodArgumentNotValidException</code>：参数校验异常  </li>
<li><code>MethodArgumentTypeMismatchException</code>：参数类型不匹配</li>
<li><code>NoSuchMethodException</code>：方法不存在</li>
<li><code>ClassCastException</code>：类型转换异常</li>
</ul>
<h3 id="🛠️-配置消费者确认模式"><a href="#🛠️-配置消费者确认模式" class="headerlink" title="🛠️ 配置消费者确认模式"></a>🛠️ 配置消费者确认模式</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">auto</span> <span class="comment"># 推荐使用auto模式</span></span><br><span class="line">        <span class="comment"># acknowledge-mode: none   # 不安全，不推荐  </span></span><br><span class="line">        <span class="comment"># acknowledge-mode: manual # 需要手动编码</span></span><br></pre></td></tr></table></figure>

<h3 id="🧪-测试不同确认模式"><a href="#🧪-测试不同确认模式" class="headerlink" title="🧪 测试不同确认模式"></a>🧪 测试不同确认模式</h3><h4 id="测试none模式"><a href="#测试none模式" class="headerlink" title="测试none模式"></a>测试none模式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;simple.queue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenSimpleQueueMessage</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;消费者接收到消息：【&#123;&#125;】&quot;</span>, msg);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MessageConversionException</span>(<span class="string">&quot;故意的异常&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    log.info(<span class="string">&quot;消息处理完成&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>配置none模式</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">none</span></span><br></pre></td></tr></table></figure>

<p><strong>结果</strong>：消息被立即删除，即使出现异常 ❌</p>
<h4 id="测试auto模式"><a href="#测试auto模式" class="headerlink" title="测试auto模式"></a>测试auto模式</h4><p><strong>配置auto模式</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">auto</span></span><br></pre></td></tr></table></figure>

<p><strong>测试1：消息转换异常</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;simple.queue&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenSimpleQueueMessage</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;消费者接收到消息：【&#123;&#125;】&quot;</span>, msg);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MessageConversionException</span>(<span class="string">&quot;消息转换异常&quot;</span>);  <span class="comment">// 会返回reject</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>结果</strong>：消息状态先变为<code>unacked</code>，异常后返回<code>reject</code>，消息被删除</p>
<p><strong>测试2：业务异常</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;simple.queue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenSimpleQueueMessage</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;消费者接收到消息：【&#123;&#125;】&quot;</span>, msg);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;业务异常&quot;</span>);  <span class="comment">// 会返回nack</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>结果</strong>：消息状态先变为<code>unacked</code>，异常后返回<code>nack</code>，消息重新回到队列</p>
<p><img src="C:\Users\Chenxin\AppData\Roaming\Typora\typora-user-images\image-20250717171958197.png" alt="image-20250717171958197"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Cxhahalala/hexo-images-1@main/images/20250717091833036.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Cxhahalala/hexo-images-1@main/images/20250717092131957.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Cxhahalala/hexo-images-1@main/images/20250717172355980.png"></p>
<h2 id="3-2-失败重试机制"><a href="#3-2-失败重试机制" class="headerlink" title="3.2 失败重试机制"></a>3.2 失败重试机制</h2><h3 id="🎯-问题场景"><a href="#🎯-问题场景" class="headerlink" title="🎯 问题场景"></a>🎯 问题场景</h3><p>当消费者出现异常后，消息会不断<strong>requeue</strong>（重新入队）到队列头部，并重新发送给消费者。</p>
<h4 id="⚠️-无限循环的危害"><a href="#⚠️-无限循环的危害" class="headerlink" title="⚠️ 无限循环的危害"></a>⚠️ 无限循环的危害</h4><p>如果消费者一直无法执行成功：</p>
<ol>
<li><strong>消息无限循环</strong>：requeue → 投递 → 异常 → requeue → …</li>
<li><strong>MQ压力飙升</strong>：消息处理频率激增  </li>
<li><strong>资源浪费</strong>：CPU、网络、磁盘IO持续消耗</li>
<li><strong>影响其他消息</strong>：阻塞正常消息处理</li>
</ol>
<h3 id="💡-本地重试机制"><a href="#💡-本地重试机制" class="headerlink" title="💡 本地重试机制"></a>💡 本地重试机制</h3><p>Spring提供了<strong>消费者失败重试机制</strong>：</p>
<ul>
<li><strong>本地重试</strong>：在消费者端进行重试，而不是requeue到MQ</li>
<li><strong>重试限制</strong>：设置最大重试次数，避免无限循环</li>
<li><strong>优雅降级</strong>：重试耗尽后的失败处理策略</li>
</ul>
<h3 id="⚙️-配置本地重试"><a href="#⚙️-配置本地重试" class="headerlink" title="⚙️ 配置本地重试"></a>⚙️ 配置本地重试</h3><p>修改consumer服务的<code>application.yml</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">retry:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启消费者失败重试</span></span><br><span class="line">          <span class="attr">initial-interval:</span> <span class="string">1000ms</span> <span class="comment"># 初始失败等待时长为1秒</span></span><br><span class="line">          <span class="attr">multiplier:</span> <span class="number">1</span> <span class="comment"># 失败等待时长倍数，下次等待时长 = multiplier * last-interval</span></span><br><span class="line">          <span class="attr">max-attempts:</span> <span class="number">3</span> <span class="comment"># 最大重试次数</span></span><br><span class="line">          <span class="attr">stateless:</span> <span class="literal">true</span> <span class="comment"># true无状态；false有状态，包含事务上下文</span></span><br></pre></td></tr></table></figure>

<h4 id="📊-参数说明"><a href="#📊-参数说明" class="headerlink" title="📊 参数说明"></a>📊 参数说明</h4><table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>推荐值</th>
</tr>
</thead>
<tbody><tr>
<td><code>enabled</code></td>
<td>是否开启重试</td>
<td><code>true</code></td>
</tr>
<tr>
<td><code>initial-interval</code></td>
<td>初始重试间隔</td>
<td><code>1000ms</code></td>
</tr>
<tr>
<td><code>multiplier</code></td>
<td>重试间隔倍数</td>
<td><code>1</code>（固定间隔）或<code>2</code>（指数退避）</td>
</tr>
<tr>
<td><code>max-attempts</code></td>
<td>最大重试次数</td>
<td><code>3-5</code></td>
</tr>
<tr>
<td><code>stateless</code></td>
<td>是否有状态</td>
<td><code>true</code>（大多数场景）</td>
</tr>
</tbody></table>
<h4 id="🔄-stateless参数详解"><a href="#🔄-stateless参数详解" class="headerlink" title="🔄 stateless参数详解"></a>🔄 stateless参数详解</h4><table>
<thead>
<tr>
<th>模式</th>
<th>特点</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><code>stateless: true</code></td>
<td>每次重试都是独立的</td>
<td>无事务、幂等操作</td>
</tr>
<tr>
<td><code>stateless: false</code></td>
<td>保留上次重试的上下文信息</td>
<td>包含事务的业务</td>
</tr>
</tbody></table>
<h3 id="🧪-测试重试效果"><a href="#🧪-测试重试效果" class="headerlink" title="🧪 测试重试效果"></a>🧪 测试重试效果</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;simple.queue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenSimpleQueueMessage</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;消费者接收到消息：【&#123;&#125;】&quot;</span>, msg);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;模拟业务异常&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试结果</strong>：</p>
<ol>
<li>消费者本地重试3次（1秒间隔）</li>
<li>重试3次后抛出<code>AmqpRejectAndDontRequeueException</code>异常</li>
<li>Spring返回<code>reject</code>，消息被删除</li>
</ol>
<h3 id="📊-重试机制对比"><a href="#📊-重试机制对比" class="headerlink" title="📊 重试机制对比"></a>📊 重试机制对比</h3><table>
<thead>
<tr>
<th>重试方式</th>
<th>重试位置</th>
<th>MQ压力</th>
<th>控制精度</th>
<th>推荐度</th>
</tr>
</thead>
<tbody><tr>
<td><strong>requeue重试</strong></td>
<td>MQ队列</td>
<td>❌ 高</td>
<td>❌ 低</td>
<td>❌ 不推荐</td>
</tr>
<tr>
<td><strong>本地重试</strong></td>
<td>消费者本地</td>
<td>✅ 低</td>
<td>✅ 高</td>
<td>✅ <strong>推荐</strong></td>
</tr>
</tbody></table>
<h3 id="🔄-重试流程图"><a href="#🔄-重试流程图" class="headerlink" title="🔄 重试流程图"></a>🔄 重试流程图</h3><pre class="mermaid">graph TD
    A[接收消息] --> B[处理消息]
    B --> C{处理成功?}
    C -->|是| D[返回ACK]
    C -->|否| E{重试次数<最大值?}
    E -->|是| F[等待间隔时间]
    F --> G[本地重试]
    G --> B
    E -->|否| H[返回REJECT]
    H --> I[消息被删除]</pre>

<h3 id="⚠️-注意事项-1"><a href="#⚠️-注意事项-1" class="headerlink" title="⚠️ 注意事项"></a>⚠️ 注意事项</h3><p><strong>本地重试的行为</strong>：</p>
<ul>
<li>✅ 消息不会requeue到队列</li>
<li>✅ 减少MQ压力</li>
<li>✅ 更精确的重试控制</li>
<li>❌ 重试耗尽后消息被丢弃（需要失败处理策略）</li>
</ul>
<h2 id="3-3-失败处理策略"><a href="#3-3-失败处理策略" class="headerlink" title="3.3 失败处理策略"></a>3.3 失败处理策略</h2><h3 id="🎯-问题分析-1"><a href="#🎯-问题分析-1" class="headerlink" title="🎯 问题分析"></a>🎯 问题分析</h3><p>本地重试达到最大次数后，消息会被丢弃。这在对消息可靠性要求较高的业务场景下显然不合适。</p>
<h3 id="💡-解决方案"><a href="#💡-解决方案" class="headerlink" title="💡 解决方案"></a>💡 解决方案</h3><p>Spring允许自定义重试次数耗尽后的消息处理策略，通过<code>MessageRecovery</code>接口定义。</p>
<h3 id="📋-三种处理策略"><a href="#📋-三种处理策略" class="headerlink" title="📋 三种处理策略"></a>📋 三种处理策略</h3><table>
<thead>
<tr>
<th>策略类型</th>
<th>类名</th>
<th>行为</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><strong>直接丢弃</strong></td>
<td><code>RejectAndDontRequeueRecoverer</code></td>
<td>直接<code>reject</code>，丢弃消息</td>
<td>对消息丢失容忍度高</td>
</tr>
<tr>
<td><strong>重新入队</strong></td>
<td><code>ImmediateRequeueMessageRecoverer</code></td>
<td>返回<code>nack</code>，消息重新入队</td>
<td>临时故障，稍后可能恢复</td>
</tr>
<tr>
<td><strong>转发异常队列</strong></td>
<td><code>RepublishMessageRecoverer</code></td>
<td>转发到指定交换机</td>
<td><strong>推荐</strong>，便于人工处理</td>
</tr>
</tbody></table>
<h3 id="🏆-推荐方案：RepublishMessageRecoverer"><a href="#🏆-推荐方案：RepublishMessageRecoverer" class="headerlink" title="🏆 推荐方案：RepublishMessageRecoverer"></a>🏆 推荐方案：RepublishMessageRecoverer</h3><p>将失败消息投递到专门的<strong>异常队列</strong>，后续由人工集中处理。</p>
<h4 id="🔧-实现步骤"><a href="#🔧-实现步骤" class="headerlink" title="🔧 实现步骤"></a>🔧 实现步骤</h4><p><strong>1）定义异常消息的交换机和队列</strong></p>
<p>在consumer服务中创建配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.consumer.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.retry.MessageRecoverer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.retry.RepublishMessageRecoverer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(name = &quot;spring.rabbitmq.listener.simple.retry.enabled&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ErrorMessageConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义异常交换机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">errorMessageExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(<span class="string">&quot;error.direct&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义异常队列  </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">errorQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;error.queue&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绑定异常队列到异常交换机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">errorBinding</span><span class="params">(Queue errorQueue, DirectExchange errorMessageExchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(errorQueue).to(errorMessageExchange).with(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义RepublishMessageRecoverer，关联队列和交换机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MessageRecoverer <span class="title function_">republishMessageRecoverer</span><span class="params">(RabbitTemplate rabbitTemplate)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RepublishMessageRecoverer</span>(rabbitTemplate, <span class="string">&quot;error.direct&quot;</span>, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="🎯-配置说明"><a href="#🎯-配置说明" class="headerlink" title="🎯 配置说明"></a>🎯 配置说明</h4><ul>
<li><strong>@ConditionalOnProperty</strong>：只有开启重试机制时才生效</li>
<li><strong>error.direct</strong>：异常交换机名称</li>
<li><strong>error.queue</strong>：异常队列名称  </li>
<li><strong>error</strong>：路由键</li>
<li><strong>RepublishMessageRecoverer</strong>：失败消息重新发布处理器</li>
</ul>
<h3 id="🧪-测试效果-1"><a href="#🧪-测试效果-1" class="headerlink" title="🧪 测试效果"></a>🧪 测试效果</h3><p><strong>1）重启consumer服务</strong></p>
<p><strong>2）发送消息触发异常</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;simple.queue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenSimpleQueueMessage</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;消费者接收到消息：【&#123;&#125;】&quot;</span>, msg);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;模拟业务异常&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3）观察结果</strong></p>
<ul>
<li>本地重试3次</li>
<li>重试耗尽后消息被发送到<code>error.queue</code></li>
<li>原始队列消息被删除</li>
<li>异常队列可以看到失败的消息</li>
</ul>
<h3 id="🔄-处理流程图"><a href="#🔄-处理流程图" class="headerlink" title="🔄 处理流程图"></a>🔄 处理流程图</h3><pre class="mermaid">graph TD
    A[消息处理] --> B{成功?}
    B -->|是| C[返回ACK]
    B -->|否| D{重试次数<最大值?}
    D -->|是| E[本地重试]
    E --> A
    D -->|否| F[RepublishMessageRecoverer]
    F --> G[发送到error.direct交换机]
    G --> H[路由到error.queue]
    H --> I[人工处理]</pre>

<h3 id="🛠️-异常消息的处理"><a href="#🛠️-异常消息的处理" class="headerlink" title="🛠️ 异常消息的处理"></a>🛠️ 异常消息的处理</h3><h4 id="方式一：人工处理"><a href="#方式一：人工处理" class="headerlink" title="方式一：人工处理"></a>方式一：人工处理</h4><ul>
<li>登录RabbitMQ控制台</li>
<li>查看<code>error.queue</code>中的消息</li>
<li>分析失败原因</li>
<li>修复问题后重新发送</li>
</ul>
<h4 id="方式二：监听异常队列"><a href="#方式二：监听异常队列" class="headerlink" title="方式二：监听异常队列"></a>方式二：监听异常队列</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;error.queue&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleErrorMessage</span><span class="params">(String msg, </span></span><br><span class="line"><span class="params">                              <span class="meta">@Header</span> Map&lt;String, Object&gt; headers,</span></span><br><span class="line"><span class="params">                              <span class="meta">@Header(&quot;x-exception-message&quot;)</span> String exceptionMessage)</span> &#123;</span><br><span class="line">    log.error(<span class="string">&quot;收到异常消息：&#123;&#125;&quot;</span>, msg);</span><br><span class="line">    log.error(<span class="string">&quot;异常信息：&#123;&#125;&quot;</span>, exceptionMessage);</span><br><span class="line">    log.error(<span class="string">&quot;原始headers：&#123;&#125;&quot;</span>, headers);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. 记录到数据库</span></span><br><span class="line">    <span class="comment">// 2. 发送告警通知  </span></span><br><span class="line">    <span class="comment">// 3. 尝试修复后重新发送</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="📊-各种策略对比"><a href="#📊-各种策略对比" class="headerlink" title="📊 各种策略对比"></a>📊 各种策略对比</h3><table>
<thead>
<tr>
<th>策略</th>
<th>消息丢失风险</th>
<th>处理复杂度</th>
<th>人工干预</th>
<th>推荐指数</th>
</tr>
</thead>
<tbody><tr>
<td><strong>RejectAndDontRequeue</strong></td>
<td>❌ 高</td>
<td>✅ 简单</td>
<td>❌ 无法</td>
<td>⭐⭐</td>
</tr>
<tr>
<td><strong>ImmediateRequeue</strong></td>
<td>✅ 低</td>
<td>❌ 复杂</td>
<td>❌ 困难</td>
<td>⭐⭐</td>
</tr>
<tr>
<td><strong>RepublishMessageRecoverer</strong></td>
<td>✅ 低</td>
<td>🔶 中等</td>
<td>✅ 便于</td>
<td>⭐⭐⭐⭐⭐</td>
</tr>
</tbody></table>
<h3 id="💡-最佳实践-1"><a href="#💡-最佳实践-1" class="headerlink" title="💡 最佳实践"></a>💡 最佳实践</h3><ol>
<li><strong>开发环境</strong>：使用<code>RejectAndDontRequeue</code>快速调试</li>
<li><strong>测试环境</strong>：使用<code>RepublishMessageRecoverer</code>测试异常处理</li>
<li><strong>生产环境</strong>：使用<code>RepublishMessageRecoverer</code> + 监控告警</li>
</ol>
<h2 id="3-4-业务幂等性"><a href="#3-4-业务幂等性" class="headerlink" title="3.4 业务幂等性"></a>3.4 业务幂等性</h2><h3 id="🎯-什么是幂等性？"><a href="#🎯-什么是幂等性？" class="headerlink" title="🎯 什么是幂等性？"></a>🎯 什么是幂等性？</h3><p><strong>幂等</strong>是数学概念，用函数表达：<code>f(x) = f(f(x))</code>，例如求绝对值函数。</p>
<p><strong>在程序开发中</strong>：同一个业务，执行一次或多次对业务状态的影响是一致的。</p>
<h4 id="📊-幂等-vs-非幂等操作"><a href="#📊-幂等-vs-非幂等操作" class="headerlink" title="📊 幂等 vs 非幂等操作"></a>📊 幂等 vs 非幂等操作</h4><table>
<thead>
<tr>
<th>操作类型</th>
<th>示例</th>
<th>重复执行结果</th>
<th>是否幂等</th>
</tr>
</thead>
<tbody><tr>
<td><strong>查询操作</strong></td>
<td>根据ID查询用户信息</td>
<td>结果不变</td>
<td>✅ 幂等</td>
</tr>
<tr>
<td><strong>删除操作</strong></td>
<td>根据ID删除数据</td>
<td>数据已删除</td>
<td>✅ 幂等</td>
</tr>
<tr>
<td><strong>新增操作</strong></td>
<td>插入唯一约束数据</td>
<td>插入失败</td>
<td>✅ 幂等</td>
</tr>
<tr>
<td><strong>更新操作</strong></td>
<td>设置状态为已支付</td>
<td>状态不变</td>
<td>✅ 幂等</td>
</tr>
<tr>
<td><strong>累加操作</strong></td>
<td>库存数量+1</td>
<td>重复累加</td>
<td>❌ 非幂等</td>
</tr>
<tr>
<td><strong>扣减操作</strong></td>
<td>退款恢复库存</td>
<td>重复恢复</td>
<td>❌ 非幂等</td>
</tr>
</tbody></table>
<h3 id="🚨-重复执行的业务风险"><a href="#🚨-重复执行的业务风险" class="headerlink" title="🚨 重复执行的业务风险"></a>🚨 重复执行的业务风险</h3><h4 id="💰-电商场景示例"><a href="#💰-电商场景示例" class="headerlink" title="💰 电商场景示例"></a>💰 电商场景示例</h4><ol>
<li><strong>订单取消</strong>：恢复库存业务如果重复执行 → 库存重复增加</li>
<li><strong>退款业务</strong>：重复退款 → 商家经济损失  </li>
<li><strong>积分发放</strong>：重复发放 → 用户获得额外积分</li>
</ol>
<h3 id="🔄-消息重复投递的场景"><a href="#🔄-消息重复投递的场景" class="headerlink" title="🔄 消息重复投递的场景"></a>🔄 消息重复投递的场景</h3><p>在实际业务中，消息重复执行很常见：</p>
<h4 id="📋-常见场景"><a href="#📋-常见场景" class="headerlink" title="📋 常见场景"></a>📋 常见场景</h4><table>
<thead>
<tr>
<th>场景</th>
<th>原因</th>
<th>后果</th>
</tr>
</thead>
<tbody><tr>
<td><strong>页面重复提交</strong></td>
<td>用户点击卡顿后多次点击</td>
<td>重复下单</td>
</tr>
<tr>
<td><strong>服务重试</strong></td>
<td>网络超时后重试调用</td>
<td>重复处理</td>
</tr>
<tr>
<td><strong>MQ重复投递</strong></td>
<td>消费者确认失败后重投</td>
<td>重复消费</td>
</tr>
</tbody></table>
<h4 id="🎭-具体案例：支付状态更新"><a href="#🎭-具体案例：支付状态更新" class="headerlink" title="🎭 具体案例：支付状态更新"></a>🎭 具体案例：支付状态更新</h4><pre class="mermaid">sequenceDiagram
    participant U as 用户
    participant P as 支付服务  
    participant MQ as RabbitMQ
    participant T as 交易服务
    
    U->>P: 支付成功
    P->>MQ: 发送支付成功消息
    MQ->>T: 投递消息
    T->>T: 更新订单状态：未支付→已支付 ✅
    
    Note over MQ,T: 网络故障，确认失败
    MQ->>T: 重新投递消息  
    Note over U,T: 此时用户已退款，订单状态：已退款
    T->>T: 再次更新：已退款→已支付 ❌</pre>

<p><strong>问题</strong>：用户已退款，但订单状态被重复消息改为已支付！</p>
<h3 id="💡-幂等性解决方案"><a href="#💡-幂等性解决方案" class="headerlink" title="💡 幂等性解决方案"></a>💡 幂等性解决方案</h3><h4 id="方案一：唯一消息ID"><a href="#方案一：唯一消息ID" class="headerlink" title="方案一：唯一消息ID"></a>方案一：唯一消息ID</h4><blockquote>
<p><strong>思路</strong>：为每条消息生成唯一ID，处理成功后记录ID，重复消息根据ID判断跳过</p>
</blockquote>
<p><strong>1）开启MessageID功能</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MessageConverter <span class="title function_">messageConverter</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">Jackson2JsonMessageConverter</span> <span class="variable">converter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">    <span class="comment">// 配置自动创建消息ID，用于识别不同消息</span></span><br><span class="line">    converter.setCreateMessageIds(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> converter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2）消费者端处理</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;payment.queue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handlePaymentMessage</span><span class="params">(PaymentMessage msg, </span></span><br><span class="line"><span class="params">                                <span class="meta">@Header(&quot;spring_returned_message_correlation&quot;)</span> String messageId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 检查消息ID是否已处理</span></span><br><span class="line">    <span class="keyword">if</span> (messageIdService.isProcessed(messageId)) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;消息已处理，跳过：&#123;&#125;&quot;</span>, messageId);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 处理业务逻辑</span></span><br><span class="line">    processPayment(msg);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 记录消息ID</span></span><br><span class="line">    messageIdService.markProcessed(messageId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3）MessageID服务实现</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageIdService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PROCESSED_KEY_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;msg:processed:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">EXPIRE_TIME</span> <span class="operator">=</span> <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span>; <span class="comment">// 24小时过期</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isProcessed</span><span class="params">(String messageId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> PROCESSED_KEY_PREFIX + messageId;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.hasKey(key);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">markProcessed</span><span class="params">(String messageId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> PROCESSED_KEY_PREFIX + messageId;</span><br><span class="line">        redisTemplate.opsForValue().set(key, <span class="string">&quot;1&quot;</span>, EXPIRE_TIME, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="方案二：业务状态判断（推荐）"><a href="#方案二：业务状态判断（推荐）" class="headerlink" title="方案二：业务状态判断（推荐）"></a>方案二：业务状态判断（推荐）</h4><blockquote>
<p><strong>思路</strong>：基于业务逻辑本身判断是否重复，无需额外存储</p>
</blockquote>
<p><strong>示例：支付状态更新</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">markOrderPaySuccess</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">    <span class="comment">// 方式1：先查询再更新（存在并发问题）</span></span><br><span class="line">    <span class="type">Order</span> <span class="variable">old</span> <span class="operator">=</span> getById(orderId);</span><br><span class="line">    <span class="keyword">if</span> (old == <span class="literal">null</span> || old.getStatus() != <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 订单不存在或状态不是未支付，跳过处理</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 更新订单状态</span></span><br><span class="line">    <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Order</span>();</span><br><span class="line">    order.setId(orderId);</span><br><span class="line">    order.setStatus(<span class="number">2</span>); <span class="comment">// 已支付</span></span><br><span class="line">    order.setPayTime(LocalDateTime.now());</span><br><span class="line">    updateById(order);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>优化：原子操作（推荐）</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">markOrderPaySuccess</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">    <span class="comment">// 使用WHERE条件确保幂等性</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">updated</span> <span class="operator">=</span> lambdaUpdate()</span><br><span class="line">            .set(Order::getStatus, <span class="number">2</span>)           <span class="comment">// 设置为已支付</span></span><br><span class="line">            .set(Order::getPayTime, LocalDateTime.now())</span><br><span class="line">            .eq(Order::getId, orderId)          <span class="comment">// 订单ID匹配</span></span><br><span class="line">            .eq(Order::getStatus, <span class="number">1</span>)            <span class="comment">// 只有未支付状态才更新</span></span><br><span class="line">            .update();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (updated == <span class="number">0</span>) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;订单&#123;&#125;状态更新跳过，可能已处理&quot;</span>, orderId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>对应SQL</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> `<span class="keyword">order</span>` </span><br><span class="line"><span class="keyword">SET</span> status <span class="operator">=</span> <span class="number">2</span>, pay_time <span class="operator">=</span> NOW() </span><br><span class="line"><span class="keyword">WHERE</span> id <span class="operator">=</span> ? <span class="keyword">AND</span> status <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="📊-两种方案对比"><a href="#📊-两种方案对比" class="headerlink" title="📊 两种方案对比"></a>📊 两种方案对比</h3><table>
<thead>
<tr>
<th>方案</th>
<th>优点</th>
<th>缺点</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><strong>唯一消息ID</strong></td>
<td>通用性强，适用各种业务</td>
<td>需要额外存储，增加复杂度</td>
<td>业务逻辑复杂，难以判断重复</td>
</tr>
<tr>
<td><strong>业务状态判断</strong></td>
<td>无需额外存储，性能好</td>
<td>需要业务支持状态判断</td>
<td><strong>推荐</strong>，业务有明确状态流转</td>
</tr>
</tbody></table>
<h3 id="🏆-最佳实践"><a href="#🏆-最佳实践" class="headerlink" title="🏆 最佳实践"></a>🏆 最佳实践</h3><ol>
<li><strong>优先使用业务状态判断</strong>：利用数据库约束和WHERE条件</li>
<li><strong>设计合理的状态流转</strong>：确保状态变更的原子性</li>
<li><strong>必要时使用消息ID</strong>：复杂业务场景的补充方案</li>
<li><strong>幂等性测试</strong>：模拟重复消息验证幂等效果</li>
</ol>
<h2 id="3-5-兜底方案"><a href="#3-5-兜底方案" class="headerlink" title="3.5 兜底方案"></a>3.5 兜底方案</h2><h3 id="🎯-为什么需要兜底方案？"><a href="#🎯-为什么需要兜底方案？" class="headerlink" title="🎯 为什么需要兜底方案？"></a>🎯 为什么需要兜底方案？</h3><p>虽然通过各种机制提升了消息可靠性，但仍无法保证100%可靠。</p>
<p><strong>万一MQ通知失败怎么办？</strong><br>需要其他兜底方案确保订单支付状态一致性。</p>
<h3 id="💡-主动查询兜底"><a href="#💡-主动查询兜底" class="headerlink" title="💡 主动查询兜底"></a>💡 主动查询兜底</h3><p><strong>核心思想</strong>：既然MQ通知可能失败，那么交易服务就<strong>主动查询</strong>支付状态。</p>
<h4 id="🔄-完整流程图"><a href="#🔄-完整流程图" class="headerlink" title="🔄 完整流程图"></a>🔄 完整流程图</h4><p><img src="C:\Users\Chenxin\AppData\Roaming\Typora\typora-user-images\image-20250717172024959.png" alt="image-20250717172024959"></p>
<p><strong>黄色圈起来的部分</strong>就是MQ通知失败后的兜底处理方案。</p>
<h3 id="⏰-定时查询策略"><a href="#⏰-定时查询策略" class="headerlink" title="⏰ 定时查询策略"></a>⏰ 定时查询策略</h3><h4 id="🤔-何时查询？"><a href="#🤔-何时查询？" class="headerlink" title="🤔 何时查询？"></a>🤔 何时查询？</h4><p>用户支付时间不确定，如果查询时机不正确可能查到错误状态。</p>
<h4 id="💡-解决方案：定时任务"><a href="#💡-解决方案：定时任务" class="headerlink" title="💡 解决方案：定时任务"></a>💡 解决方案：定时任务</h4><p>采用<strong>定时任务</strong>定期查询支付状态：</p>
<ul>
<li><strong>查询频率</strong>：每隔20秒查询一次</li>
<li><strong>查询逻辑</strong>：判断支付状态，如已支付则更新订单状态</li>
<li><strong>查询时长</strong>：根据业务设定（如30分钟内）</li>
</ul>
<h4 id="📋-实现示例"><a href="#📋-实现示例" class="headerlink" title="📋 实现示例"></a>📋 实现示例</h4><p><strong>1）定时任务配置</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderStatusCheckTask</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span>  </span><br><span class="line">    <span class="keyword">private</span> PaymentService paymentService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 每20秒检查一次未支付订单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(fixedDelay = 20000)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkUnpaidOrders</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 查询5分钟内创建但未支付的订单</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">cutoffTime</span> <span class="operator">=</span> LocalDateTime.now().minusMinutes(<span class="number">5</span>);</span><br><span class="line">        List&lt;Order&gt; unpaidOrders = orderService.getUnpaidOrdersAfter(cutoffTime);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (Order order : unpaidOrders) &#123;</span><br><span class="line">            checkAndUpdateOrderStatus(order);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkAndUpdateOrderStatus</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 查询支付状态</span></span><br><span class="line">            <span class="type">PaymentStatus</span> <span class="variable">status</span> <span class="operator">=</span> paymentService.getPaymentStatus(order.getId());</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (status == PaymentStatus.PAID) &#123;</span><br><span class="line">                <span class="comment">// 支付成功，更新订单状态</span></span><br><span class="line">                orderService.markOrderPaySuccess(order.getId());</span><br><span class="line">                log.info(<span class="string">&quot;定时任务检测到订单&#123;&#125;已支付，状态已更新&quot;</span>, order.getId());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;检查订单&#123;&#125;支付状态失败&quot;</span>, order.getId(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2）查询未支付订单</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询指定时间后创建的未支付订单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Order&gt; <span class="title function_">getUnpaidOrdersAfter</span><span class="params">(LocalDateTime createTime)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> lambdaQuery()</span><br><span class="line">                .eq(Order::getStatus, <span class="number">1</span>)  <span class="comment">// 未支付状态</span></span><br><span class="line">                .ge(Order::getCreateTime, createTime)  <span class="comment">// 创建时间大于指定时间</span></span><br><span class="line">                .list();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="🔄-双重保障机制"><a href="#🔄-双重保障机制" class="headerlink" title="🔄 双重保障机制"></a>🔄 双重保障机制</h3><h4 id="📊-保障策略对比"><a href="#📊-保障策略对比" class="headerlink" title="📊 保障策略对比"></a>📊 保障策略对比</h4><table>
<thead>
<tr>
<th>保障方式</th>
<th>实时性</th>
<th>可靠性</th>
<th>实现复杂度</th>
<th>资源消耗</th>
</tr>
</thead>
<tbody><tr>
<td><strong>MQ通知</strong></td>
<td>✅ 高</td>
<td>🔶 中等</td>
<td>🔶 中等</td>
<td>✅ 低</td>
</tr>
<tr>
<td><strong>定时查询</strong></td>
<td>❌ 低</td>
<td>✅ 高</td>
<td>✅ 简单</td>
<td>❌ 高</td>
</tr>
<tr>
<td><strong>双重保障</strong></td>
<td>✅ 高</td>
<td>✅ 高</td>
<td>❌ 复杂</td>
<td>🔶 中等</td>
</tr>
</tbody></table>
<h4 id="🏆-最佳实践组合"><a href="#🏆-最佳实践组合" class="headerlink" title="🏆 最佳实践组合"></a>🏆 最佳实践组合</h4><pre class="mermaid">graph TD
    A[用户支付成功] --> B(支付服务记录支付)
    B --> C(发送MQ消息)
    C --> D{MQ通知成功?}
    D -- "是" --> E(交易服务更新订单状态)
    D -- "否" --> F(定时任务兜底)
    F --> G(主动查询支付状态)
    G --> H{已支付?}
    H -- "是" --> E
    H -- "否" --> I(继续等待下次检查)
    E --> J(订单状态一致)</pre>

<h3 id="⚙️-定时任务优化"><a href="#⚙️-定时任务优化" class="headerlink" title="⚙️ 定时任务优化"></a>⚙️ 定时任务优化</h3><h4 id="📈-性能优化策略"><a href="#📈-性能优化策略" class="headerlink" title="📈 性能优化策略"></a>📈 性能优化策略</h4><p><strong>1）减少查询范围</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只查询特定时间窗口内的订单</span></span><br><span class="line"><span class="type">LocalDateTime</span> <span class="variable">startTime</span> <span class="operator">=</span> LocalDateTime.now().minusMinutes(<span class="number">30</span>);  <span class="comment">// 30分钟前</span></span><br><span class="line"><span class="type">LocalDateTime</span> <span class="variable">endTime</span> <span class="operator">=</span> LocalDateTime.now().minusMinutes(<span class="number">1</span>);     <span class="comment">// 1分钟前</span></span><br><span class="line"></span><br><span class="line">List&lt;Order&gt; orders = orderService.getUnpaidOrdersBetween(startTime, endTime);</span><br></pre></td></tr></table></figure>

<p><strong>2）分批处理</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Scheduled(fixedDelay = 20000)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkUnpaidOrdersBatch</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">pageSize</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">page</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        List&lt;Order&gt; orders = orderService.getUnpaidOrdersPaged(page, pageSize);</span><br><span class="line">        <span class="keyword">if</span> (orders.isEmpty()) <span class="keyword">break</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (Order order : orders) &#123;</span><br><span class="line">            checkAndUpdateOrderStatus(order);</span><br><span class="line">        &#125;</span><br><span class="line">        page++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3）异步处理</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Async</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkOrderStatusAsync</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">    checkAndUpdateOrderStatus(order);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="📊-完整可靠性方案总结"><a href="#📊-完整可靠性方案总结" class="headerlink" title="📊 完整可靠性方案总结"></a>📊 完整可靠性方案总结</h3><table>
<thead>
<tr>
<th>环节</th>
<th>主要策略</th>
<th>兜底方案</th>
</tr>
</thead>
<tbody><tr>
<td><strong>发送阶段</strong></td>
<td>重试机制 + 生产者确认</td>
<td>业务补偿</td>
</tr>
<tr>
<td><strong>存储阶段</strong></td>
<td>数据持久化 + LazyQueue</td>
<td>集群部署</td>
</tr>
<tr>
<td><strong>消费阶段</strong></td>
<td>消费者确认 + 失败重试</td>
<td>异常队列</td>
</tr>
<tr>
<td><strong>业务幂等</strong></td>
<td>状态判断 + 唯一ID</td>
<td>-</td>
</tr>
<tr>
<td><strong>最终一致性</strong></td>
<td>MQ通知</td>
<td><strong>定时任务主动查询</strong></td>
</tr>
</tbody></table>
<h3 id="🎯-方案选择建议"><a href="#🎯-方案选择建议" class="headerlink" title="🎯 方案选择建议"></a>🎯 方案选择建议</h3><h4 id="📊-业务场景匹配"><a href="#📊-业务场景匹配" class="headerlink" title="📊 业务场景匹配"></a>📊 业务场景匹配</h4><table>
<thead>
<tr>
<th>业务类型</th>
<th>推荐方案</th>
<th>理由</th>
</tr>
</thead>
<tbody><tr>
<td><strong>高实时性</strong></td>
<td>MQ通知为主</td>
<td>用户体验优先</td>
</tr>
<tr>
<td><strong>高可靠性</strong></td>
<td>MQ + 定时任务</td>
<td>数据一致性优先</td>
</tr>
<tr>
<td><strong>资源敏感</strong></td>
<td>延长MQ重试</td>
<td>减少定时任务开销</td>
</tr>
<tr>
<td><strong>复杂业务</strong></td>
<td>全套方案</td>
<td>多重保障</td>
</tr>
</tbody></table>
<p>这样的设计既保证了实时性，又提供了可靠的兜底机制，确保了订单支付状态的最终一致性。</p>
<h1 id="4-延迟消息"><a href="#4-延迟消息" class="headerlink" title="4. 延迟消息"></a>4. 延迟消息</h1><h2 id="4-1-延迟消息的应用场景"><a href="#4-1-延迟消息的应用场景" class="headerlink" title="4.1 延迟消息的应用场景"></a>4.1 延迟消息的应用场景</h2><h3 id="📱-电商支付超时场景"><a href="#📱-电商支付超时场景" class="headerlink" title="📱 电商支付超时场景"></a>📱 电商支付超时场景</h3><p>在电商系统中，为了更好的用户体验，用户下单后通常立即扣减库存：</p>
<p><strong>优点</strong>：</p>
<ul>
<li>✅ 座位&#x2F;商品立即锁定</li>
<li>✅ 用户体验好</li>
<li>✅ 防止超卖</li>
</ul>
<p><strong>问题</strong>：</p>
<ul>
<li>❌ 用户下单后一直不付款</li>
<li>❌ 库存长期被占用  </li>
<li>❌ 其他用户无法购买</li>
<li>❌ 商户利益受损</li>
</ul>
<h3 id="💡-解决方案：延迟任务"><a href="#💡-解决方案：延迟任务" class="headerlink" title="💡 解决方案：延迟任务"></a>💡 解决方案：延迟任务</h3><p><strong>业务需求</strong>：对于超过一定时间未支付的订单，应该立即取消并释放库存。</p>
<h4 id="🎯-典型场景"><a href="#🎯-典型场景" class="headerlink" title="🎯 典型场景"></a>🎯 典型场景</h4><table>
<thead>
<tr>
<th>业务场景</th>
<th>延迟时间</th>
<th>触发动作</th>
</tr>
</thead>
<tbody><tr>
<td><strong>订单支付</strong></td>
<td>30分钟</td>
<td>取消订单，释放库存</td>
</tr>
<tr>
<td><strong>优惠券</strong></td>
<td>3天</td>
<td>回收未使用优惠券</td>
</tr>
<tr>
<td><strong>账户激活</strong></td>
<td>24小时</td>
<td>发送激活提醒邮件</td>
</tr>
<tr>
<td><strong>会员续费</strong></td>
<td>7天</td>
<td>发送续费提醒</td>
</tr>
</tbody></table>
<h3 id="❓-技术挑战"><a href="#❓-技术挑战" class="headerlink" title="❓ 技术挑战"></a>❓ 技术挑战</h3><p><strong>如何准确实现”下单后第30分钟检查支付状态”？</strong></p>
<p>这就是<strong>延迟任务</strong>，要实现延迟任务，最简单的方案就是利用MQ的延迟消息。</p>
<h3 id="🔧-RabbitMQ延迟消息方案"><a href="#🔧-RabbitMQ延迟消息方案" class="headerlink" title="🔧 RabbitMQ延迟消息方案"></a>🔧 RabbitMQ延迟消息方案</h3><table>
<thead>
<tr>
<th>方案</th>
<th>原理</th>
<th>优点</th>
<th>缺点</th>
<th>推荐度</th>
</tr>
</thead>
<tbody><tr>
<td><strong>死信交换机+TTL</strong></td>
<td>消息过期变死信</td>
<td>不需插件</td>
<td>时间不准确</td>
<td>⭐⭐⭐</td>
</tr>
<tr>
<td><strong>延迟消息插件</strong></td>
<td>插件原生支持</td>
<td>时间准确</td>
<td>需要插件</td>
<td>⭐⭐⭐⭐⭐</td>
</tr>
</tbody></table>
<h2 id="4-2-死信交换机和延迟消息"><a href="#4-2-死信交换机和延迟消息" class="headerlink" title="4.2 死信交换机和延迟消息"></a>4.2 死信交换机和延迟消息</h2><h3 id="4-2-1-死信交换机"><a href="#4-2-1-死信交换机" class="headerlink" title="4.2.1 死信交换机"></a>4.2.1 死信交换机</h3><h4 id="🎯-什么是死信？"><a href="#🎯-什么是死信？" class="headerlink" title="🎯 什么是死信？"></a>🎯 什么是死信？</h4><p>当队列中的消息满足以下条件之一时，可以成为<strong>死信</strong>（dead letter）：</p>
<table>
<thead>
<tr>
<th>死信产生条件</th>
<th>描述</th>
<th>示例场景</th>
</tr>
</thead>
<tbody><tr>
<td><strong>消费者拒绝</strong></td>
<td><code>basic.reject</code>或<code>basic.nack</code>且<code>requeue=false</code></td>
<td>消息格式错误</td>
</tr>
<tr>
<td><strong>消息过期</strong></td>
<td>超过TTL时间无人消费</td>
<td>延迟消息场景</td>
</tr>
<tr>
<td><strong>队列满载</strong></td>
<td>队列达到最大长度，无法投递</td>
<td>消息积压</td>
</tr>
</tbody></table>
<h4 id="🔄-死信交换机工作原理"><a href="#🔄-死信交换机工作原理" class="headerlink" title="🔄 死信交换机工作原理"></a>🔄 死信交换机工作原理</h4><p>当队列通过<code>dead-letter-exchange</code>属性指定了交换机，死信就会投递到该交换机：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置死信交换机</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">orderQueue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> QueueBuilder.durable(<span class="string">&quot;order.queue&quot;</span>)</span><br><span class="line">            .withArgument(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, <span class="string">&quot;order.dlx.exchange&quot;</span>)    <span class="comment">// 死信交换机</span></span><br><span class="line">            .withArgument(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;order.timeout&quot;</span>)      <span class="comment">// 死信路由键</span></span><br><span class="line">            .withArgument(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">30</span> * <span class="number">60</span> * <span class="number">1000</span>)                   <span class="comment">// 30分钟TTL</span></span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="📋-死信交换机的作用"><a href="#📋-死信交换机的作用" class="headerlink" title="📋 死信交换机的作用"></a>📋 死信交换机的作用</h4><ol>
<li><strong>异常处理</strong>：收集处理失败的消息</li>
<li><strong>过载保护</strong>：收集队列满载时的消息  </li>
<li><strong>延迟消息</strong>：⭐ 收集TTL过期的消息（延迟消息实现）</li>
</ol>
<h3 id="4-2-2-延迟消息实现"><a href="#4-2-2-延迟消息实现" class="headerlink" title="4.2.2 延迟消息实现"></a>4.2.2 延迟消息实现</h3><h4 id="🏗️-系统架构设计"><a href="#🏗️-系统架构设计" class="headerlink" title="🏗️ 系统架构设计"></a>🏗️ 系统架构设计</h4><p>假设我们有这样的绑定关系：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Cxhahalala/hexo-images-1@main/images/20250717172036841.png"></p>
<h4 id="🔄-工作流程-1"><a href="#🔄-工作流程-1" class="headerlink" title="🔄 工作流程"></a>🔄 工作流程</h4><p><strong>1）发送延迟消息</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 发送消息到ttl.fanout，routingKey为blue，TTL=5000ms</span></span><br><span class="line">rabbitTemplate.convertAndSend(<span class="string">&quot;ttl.fanout&quot;</span>, <span class="string">&quot;blue&quot;</span>, <span class="string">&quot;延迟消息&quot;</span>, message -&gt; &#123;</span><br><span class="line">    message.getMessageProperties().setExpiration(<span class="string">&quot;5000&quot;</span>);  <span class="comment">// 5秒后过期</span></span><br><span class="line">    <span class="keyword">return</span> message;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>2）消息流转过程</strong></p>
<pre class="mermaid">graph LR
    A[发送消息] --> B[ttl.fanout交换机]
    B --> C[ttl.queue队列]
    C --> D[等待5秒TTL过期]
    D --> E[变成死信]
    E --> F[投递到hmall.direct]
    F --> G[路由到direct.queue1]
    G --> H[消费者消费]</pre>

<p><strong>3）时间轴分析</strong></p>
<table>
<thead>
<tr>
<th>时间点</th>
<th>事件</th>
<th>消息位置</th>
</tr>
</thead>
<tbody><tr>
<td>T+0s</td>
<td>发送消息</td>
<td>ttl.queue</td>
</tr>
<tr>
<td>T+1-4s</td>
<td>等待过期</td>
<td>ttl.queue</td>
</tr>
<tr>
<td>T+5s</td>
<td>TTL过期</td>
<td>变成死信</td>
</tr>
<tr>
<td>T+5s</td>
<td>死信投递</td>
<td>direct.queue1</td>
</tr>
<tr>
<td>T+5s</td>
<td>消费者消费</td>
<td>被处理</td>
</tr>
</tbody></table>
<p><img src="https://cdn.jsdelivr.net/gh/Cxhahalala/hexo-images-1@main/images/20250717172059282.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Cxhahalala/hexo-images-1@main/images/20250717172111242.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Cxhahalala/hexo-images-1@main/images/20250717172130452.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Cxhahalala/hexo-images-1@main/images/20250717172203928.png"></p>
<h4 id="🎯-实现效果"><a href="#🎯-实现效果" class="headerlink" title="🎯 实现效果"></a>🎯 实现效果</h4><p><strong>成功实现延迟消息</strong>：发送者发送消息，消费者在5秒后收到消息！</p>
<h3 id="4-2-3-死信-TTL方案总结"><a href="#4-2-3-死信-TTL方案总结" class="headerlink" title="4.2.3 死信+TTL方案总结"></a>4.2.3 死信+TTL方案总结</h3><h4 id="✅-优点"><a href="#✅-优点" class="headerlink" title="✅ 优点"></a>✅ 优点</h4><ul>
<li>无需额外插件</li>
<li>利用RabbitMQ原生特性</li>
<li>配置相对简单</li>
</ul>
<h4 id="❌-缺点"><a href="#❌-缺点" class="headerlink" title="❌ 缺点"></a>❌ 缺点</h4><p><strong>⚠️ 时间不准确问题</strong></p>
<p>RabbitMQ的消息过期基于<strong>追溯方式</strong>实现：</p>
<ul>
<li>消息TTL到期后不会立即处理</li>
<li>只有当消息<strong>处于队列头部</strong>时才会被处理</li>
<li>队列消息堆积时，过期消息可能不会按时处理</li>
</ul>
<h4 id="📊-场景分析"><a href="#📊-场景分析" class="headerlink" title="📊 场景分析"></a>📊 场景分析</h4><table>
<thead>
<tr>
<th>队列状态</th>
<th>延迟准确性</th>
<th>适用性</th>
</tr>
</thead>
<tbody><tr>
<td><strong>空闲状态</strong></td>
<td>✅ 准确</td>
<td>✅ 适用</td>
</tr>
<tr>
<td><strong>少量积压</strong></td>
<td>🔶 基本准确</td>
<td>🔶 可接受</td>
</tr>
<tr>
<td><strong>大量积压</strong></td>
<td>❌ 不准确</td>
<td>❌ 不适用</td>
</tr>
</tbody></table>
<h4 id="💡-使用建议"><a href="#💡-使用建议" class="headerlink" title="💡 使用建议"></a>💡 使用建议</h4><ul>
<li><strong>适用场景</strong>：对时间精度要求不高的业务</li>
<li><strong>不适用场景</strong>：需要精确延迟时间的业务</li>
<li><strong>替代方案</strong>：延迟消息插件</li>
</ul>
<h2 id="4-3-DelayExchange插件（推荐方案）"><a href="#4-3-DelayExchange插件（推荐方案）" class="headerlink" title="4.3 DelayExchange插件（推荐方案）"></a>4.3 DelayExchange插件（推荐方案）</h2><h3 id="🎯-插件优势"><a href="#🎯-插件优势" class="headerlink" title="🎯 插件优势"></a>🎯 插件优势</h3><p>基于死信队列虽然可以实现延迟消息，但过于复杂。<strong>RabbitMQ社区提供了延迟消息插件</strong>来实现相同效果。</p>
<h4 id="📊-方案对比"><a href="#📊-方案对比" class="headerlink" title="📊 方案对比"></a>📊 方案对比</h4><table>
<thead>
<tr>
<th>方案特点</th>
<th>死信+TTL</th>
<th>DelayExchange插件</th>
</tr>
</thead>
<tbody><tr>
<td><strong>配置复杂度</strong></td>
<td>❌ 复杂</td>
<td>✅ 简单</td>
</tr>
<tr>
<td><strong>时间准确性</strong></td>
<td>❌ 不准确</td>
<td>✅ 准确</td>
</tr>
<tr>
<td><strong>性能开销</strong></td>
<td>✅ 低</td>
<td>🔶 中等</td>
</tr>
<tr>
<td><strong>插件依赖</strong></td>
<td>✅ 无需插件</td>
<td>❌ 需要插件</td>
</tr>
<tr>
<td><strong>推荐度</strong></td>
<td>⭐⭐⭐</td>
<td>⭐⭐⭐⭐⭐</td>
</tr>
</tbody></table>
<h3 id="🔄-延迟交换机工作机制"><a href="#🔄-延迟交换机工作机制" class="headerlink" title="🔄 延迟交换机工作机制"></a>🔄 延迟交换机工作机制</h3><h4 id="🆚-三种流程对比"><a href="#🆚-三种流程对比" class="headerlink" title="🆚 三种流程对比"></a>🆚 三种流程对比</h4><p><strong>普通交换机流程：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">发送者 → 交换机 → [立即路由] → 队列 → 消费者</span><br></pre></td></tr></table></figure>

<p><strong>TTL过期流程：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">发送者 → 交换机 → [立即路由] → 队列 → [等待TTL过期] → 死信交换机 → 死信队列 → 消费者</span><br></pre></td></tr></table></figure>

<p><strong>延迟交换机流程：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">发送者 → 延迟交换机 → [等待延迟时间] → 路由到队列 → 消费者 [立即消费]</span><br></pre></td></tr></table></figure>

<h4 id="🎯-核心区别"><a href="#🎯-核心区别" class="headerlink" title="🎯 核心区别"></a>🎯 核心区别</h4><table>
<thead>
<tr>
<th>阶段</th>
<th>死信+TTL</th>
<th>延迟交换机</th>
</tr>
</thead>
<tbody><tr>
<td><strong>消息存储</strong></td>
<td>队列中等待过期</td>
<td><strong>交换机中暂存</strong></td>
</tr>
<tr>
<td><strong>延迟控制</strong></td>
<td>队列TTL设置</td>
<td><strong>消息头x-delay</strong></td>
</tr>
<tr>
<td><strong>路由时机</strong></td>
<td>立即路由，队列等待</td>
<td><strong>延迟后才路由</strong></td>
</tr>
</tbody></table>
<h3 id="4-3-1-插件下载与安装"><a href="#4-3-1-插件下载与安装" class="headerlink" title="4.3.1 插件下载与安装"></a>4.3.1 插件下载与安装</h3><h4 id="📥-下载插件"><a href="#📥-下载插件" class="headerlink" title="📥 下载插件"></a>📥 下载插件</h4><p><strong>官方地址</strong>：<a target="_blank" rel="noopener" href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange">GitHub - rabbitmq&#x2F;rabbitmq-delayed-message-exchange</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/Cxhahalala/hexo-images-1@main/images/20250717144510473.png"></p>
<p><strong>选择版本</strong>：下载与RabbitMQ版本对应的.ez文件</p>
<h4 id="⚙️-安装步骤"><a href="#⚙️-安装步骤" class="headerlink" title="⚙️ 安装步骤"></a>⚙️ 安装步骤</h4><p><strong>1）复制插件到plugins目录</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 复制到RabbitMQ的plugins目录</span></span><br><span class="line"><span class="built_in">cp</span> rabbitmq_delayed_message_exchange-3.10.2.ez /usr/lib/rabbitmq/lib/rabbitmq_server-3.10.2/plugins/</span><br></pre></td></tr></table></figure>

<p><strong>2）启用插件</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入sbin目录</span></span><br><span class="line"><span class="built_in">cd</span> /usr/lib/rabbitmq/lib/rabbitmq_server-3.10.2/sbin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用插件</span></span><br><span class="line">rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_delayed_message_exchange</span><br></pre></td></tr></table></figure>

<p><strong>Windows示例</strong>：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">New_SoftWare</span>\<span class="title">rabbitmq_server</span>-4.1.0\<span class="title">sbin</span>&gt;<span class="title">rabbitmq</span>-<span class="title">plugins</span> <span class="title">enable</span> <span class="title">rabbitmq_delayed_message_exchange</span></span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Cxhahalala/hexo-images-1@main/images/20250717145326624.png"></p>
<p><strong>3）重启RabbitMQ服务</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart rabbitmq-server</span><br></pre></td></tr></table></figure>

<h3 id="4-3-2-声明延迟交换机"><a href="#4-3-2-声明延迟交换机" class="headerlink" title="4.3.2 声明延迟交换机"></a>4.3.2 声明延迟交换机</h3><h4 id="🎯-重要原则"><a href="#🎯-重要原则" class="headerlink" title="🎯 重要原则"></a>🎯 重要原则</h4><p><strong>延迟交换机只需在消费者端声明</strong>，生产者直接使用交换机名称发送消息即可。</p>
<h4 id="📝-方式一：基于注解"><a href="#📝-方式一：基于注解" class="headerlink" title="📝 方式一：基于注解"></a>📝 方式一：基于注解</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue(name = &quot;delay.queue&quot;, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(name = &quot;delay.direct&quot;, delayed = &quot;true&quot;),  // 关键：delayed = &quot;true&quot;</span></span><br><span class="line"><span class="meta">        key = &quot;delay&quot;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenDelayMessage</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;接收到delay.queue的延迟消息：&#123;&#125;&quot;</span>, msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="📝-方式二：基于-Bean配置"><a href="#📝-方式二：基于-Bean配置" class="headerlink" title="📝 方式二：基于@Bean配置"></a>📝 方式二：基于@Bean配置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayExchangeConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 延迟交换机 - 本质是DirectExchange + 延迟功能</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">delayExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ExchangeBuilder.directExchange(<span class="string">&quot;delay.exchange&quot;</span>)</span><br><span class="line">                .durable(<span class="literal">true</span>)</span><br><span class="line">                .delayed()  <span class="comment">// 🎯 关键：启用延迟功能</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 普通队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">delayQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;delay.queue&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绑定队列和延迟交换机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">delayBinding</span><span class="params">(Queue delayQueue, DirectExchange delayExchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(delayQueue)</span><br><span class="line">                .to(delayExchange)</span><br><span class="line">                .with(<span class="string">&quot;delay&quot;</span>);  <span class="comment">// routing key</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-3-发送延迟消息"><a href="#4-3-3-发送延迟消息" class="headerlink" title="4.3.3 发送延迟消息"></a>4.3.3 发送延迟消息</h3><h4 id="🔑-核心要点"><a href="#🔑-核心要点" class="headerlink" title="🔑 核心要点"></a>🔑 核心要点</h4><p>发送消息时，必须通过<strong>x-delay属性</strong>设定延迟时间：</p>
<h4 id="📝-基础用法"><a href="#📝-基础用法" class="headerlink" title="📝 基础用法"></a>📝 基础用法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试延迟消息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDelayMessage</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;delay.exchange&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">routingKey</span> <span class="operator">=</span> <span class="string">&quot;delay&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;hello,delay&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 使用MessagePostProcessor设置延迟时间</span></span><br><span class="line">    rabbitTemplate.convertAndSend(exchangeName, routingKey, message, msg -&gt; &#123;</span><br><span class="line">        <span class="comment">// 🎯 设置延迟时间为10秒（毫秒单位）</span></span><br><span class="line">        msg.getMessageProperties().setHeader(<span class="string">&quot;x-delay&quot;</span>, <span class="number">10000</span>);</span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    log.info(<span class="string">&quot;延迟消息已发送，将在10秒后被消费&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="🔧-MessagePostProcessor说明"><a href="#🔧-MessagePostProcessor说明" class="headerlink" title="🔧 MessagePostProcessor说明"></a>🔧 MessagePostProcessor说明</h4><p><strong>MessagePostProcessor是函数式接口</strong>，用于在发送前修改消息属性：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Cxhahalala/hexo-images-1@main/images/20250717151808746.png"></p>
<h4 id="📋-实用示例"><a href="#📋-实用示例" class="headerlink" title="📋 实用示例"></a>📋 实用示例</h4><p><strong>1）封装延迟消息工具方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayMessageService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送延迟消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exchange 交换机名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> routingKey 路由键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 消息内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delaySeconds 延迟秒数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendDelayMessage</span><span class="params">(String exchange, String routingKey, Object message, <span class="type">int</span> delaySeconds)</span> &#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(exchange, routingKey, message, msg -&gt; &#123;</span><br><span class="line">            msg.getMessageProperties().setHeader(<span class="string">&quot;x-delay&quot;</span>, delaySeconds * <span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">return</span> msg;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2）业务场景应用</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DelayMessageService delayMessageService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建订单并发送超时检查消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createOrder</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 保存订单</span></span><br><span class="line">        orderMapper.insert(order);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 发送30分钟后的超时检查消息</span></span><br><span class="line">        delayMessageService.sendDelayMessage(</span><br><span class="line">            <span class="string">&quot;order.delay.exchange&quot;</span>, </span><br><span class="line">            <span class="string">&quot;order.timeout.check&quot;</span>, </span><br><span class="line">            order.getId(), </span><br><span class="line">            <span class="number">30</span> * <span class="number">60</span>  <span class="comment">// 30分钟</span></span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        log.info(<span class="string">&quot;订单创建成功，30分钟后将检查支付状态&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3）多层延迟检查</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 分层检查订单状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendOrderCheckMessages</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">    <span class="comment">// 5分钟后第一次检查</span></span><br><span class="line">    delayMessageService.sendDelayMessage(<span class="string">&quot;order.delay.exchange&quot;</span>, <span class="string">&quot;order.check&quot;</span>, orderId, <span class="number">5</span> * <span class="number">60</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 15分钟后第二次检查  </span></span><br><span class="line">    delayMessageService.sendDelayMessage(<span class="string">&quot;order.delay.exchange&quot;</span>, <span class="string">&quot;order.check&quot;</span>, orderId, <span class="number">15</span> * <span class="number">60</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 30分钟后最终检查</span></span><br><span class="line">    delayMessageService.sendDelayMessage(<span class="string">&quot;order.delay.exchange&quot;</span>, <span class="string">&quot;order.timeout&quot;</span>, orderId, <span class="number">30</span> * <span class="number">60</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="⚠️-重要注意事项"><a href="#⚠️-重要注意事项" class="headerlink" title="⚠️ 重要注意事项"></a>⚠️ 重要注意事项</h3><h4 id="🚨-性能警告"><a href="#🚨-性能警告" class="headerlink" title="🚨 性能警告"></a>🚨 性能警告</h4><p>延迟消息插件内部机制：</p>
<ul>
<li><strong>本地数据库表</strong>：维护延迟消息</li>
<li><strong>Elang Timers</strong>：实现计时功能  </li>
<li><strong>内存开销</strong>：长延迟消息占用CPU资源</li>
<li><strong>时间误差</strong>：极长延迟可能存在误差</li>
</ul>
<h4 id="💡-使用建议-1"><a href="#💡-使用建议-1" class="headerlink" title="💡 使用建议"></a>💡 使用建议</h4><table>
<thead>
<tr>
<th>延迟时长</th>
<th>建议</th>
<th>原因</th>
</tr>
</thead>
<tbody><tr>
<td><strong>&lt; 1小时</strong></td>
<td>✅ 推荐使用</td>
<td>性能影响小</td>
</tr>
<tr>
<td><strong>1-6小时</strong></td>
<td>🔶 谨慎使用</td>
<td>注意监控资源</td>
</tr>
<tr>
<td><strong>&gt; 6小时</strong></td>
<td>❌ 不建议</td>
<td>考虑其他方案</td>
</tr>
</tbody></table>
<h4 id="🔄-长延迟替代方案"><a href="#🔄-长延迟替代方案" class="headerlink" title="🔄 长延迟替代方案"></a>🔄 长延迟替代方案</h4><p><strong>方案1：分段延迟</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不要发送6小时的延迟消息</span></span><br><span class="line"><span class="comment">// 而是每小时发送一次检查消息</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">6</span>; i++) &#123;</span><br><span class="line">    sendDelayMessage(<span class="string">&quot;check.exchange&quot;</span>, <span class="string">&quot;hourly.check&quot;</span>, orderId, i * <span class="number">60</span> * <span class="number">60</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>方案2：定时任务配合</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 延迟消息 + 定时任务的混合方案</span></span><br><span class="line"><span class="comment">// 延迟消息处理短期任务（&lt; 1小时）</span></span><br><span class="line"><span class="comment">// 定时任务处理长期任务（&gt; 1小时）</span></span><br></pre></td></tr></table></figure>

<h3 id="🎯-延迟消息最佳实践"><a href="#🎯-延迟消息最佳实践" class="headerlink" title="🎯 延迟消息最佳实践"></a>🎯 延迟消息最佳实践</h3><ol>
<li><strong>优先使用延迟消息插件</strong>：准确性高于死信+TTL</li>
<li><strong>控制延迟时长</strong>：避免超长延迟消息</li>
<li><strong>合理设计粒度</strong>：分段检查代替单次长延迟</li>
<li><strong>监控资源使用</strong>：关注CPU和内存占用</li>
<li><strong>幂等性设计</strong>：确保重复消息处理的安全性</li>
</ol>
<h2 id="4-4-延迟消息实际应用场景"><a href="#4-4-延迟消息实际应用场景" class="headerlink" title="4.4 延迟消息实际应用场景"></a>4.4 延迟消息实际应用场景</h2><h3 id="📱-常见业务场景"><a href="#📱-常见业务场景" class="headerlink" title="📱 常见业务场景"></a>📱 常见业务场景</h3><h4 id="1️⃣-电商订单管理"><a href="#1️⃣-电商订单管理" class="headerlink" title="1️⃣ 电商订单管理"></a>1️⃣ 电商订单管理</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderDelayService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DelayMessageService delayMessageService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单超时取消场景</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleOrderTimeout</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">        <span class="comment">// 发送分段检查消息，避免长时间占用资源</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 10分钟后首次检查</span></span><br><span class="line">        delayMessageService.sendDelayMessage(</span><br><span class="line">            <span class="string">&quot;order.delay.exchange&quot;</span>, </span><br><span class="line">            <span class="string">&quot;order.check&quot;</span>, </span><br><span class="line">            orderId, </span><br><span class="line">            <span class="number">10</span> * <span class="number">60</span></span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 20分钟后二次检查</span></span><br><span class="line">        delayMessageService.sendDelayMessage(</span><br><span class="line">            <span class="string">&quot;order.delay.exchange&quot;</span>, </span><br><span class="line">            <span class="string">&quot;order.check&quot;</span>, </span><br><span class="line">            orderId, </span><br><span class="line">            <span class="number">20</span> * <span class="number">60</span></span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 30分钟后最终超时处理</span></span><br><span class="line">        delayMessageService.sendDelayMessage(</span><br><span class="line">            <span class="string">&quot;order.delay.exchange&quot;</span>, </span><br><span class="line">            <span class="string">&quot;order.timeout&quot;</span>, </span><br><span class="line">            orderId, </span><br><span class="line">            <span class="number">30</span> * <span class="number">60</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理订单检查消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;order.check.queue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleOrderCheck</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">        <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderService.getById(orderId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (order == <span class="literal">null</span> || order.getStatus() != OrderStatus.UNPAID) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;订单&#123;&#125;状态已变更，跳过检查&quot;</span>, orderId);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查支付状态</span></span><br><span class="line">        <span class="type">PaymentStatus</span> <span class="variable">paymentStatus</span> <span class="operator">=</span> paymentService.getPaymentStatus(orderId);</span><br><span class="line">        <span class="keyword">if</span> (paymentStatus == PaymentStatus.PAID) &#123;</span><br><span class="line">            orderService.markOrderPaid(orderId);</span><br><span class="line">            log.info(<span class="string">&quot;订单&#123;&#125;支付成功&quot;</span>, orderId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理订单超时</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;order.timeout.queue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleOrderTimeout</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">        <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderService.getById(orderId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (order != <span class="literal">null</span> &amp;&amp; order.getStatus() == OrderStatus.UNPAID) &#123;</span><br><span class="line">            <span class="comment">// 取消订单并释放库存</span></span><br><span class="line">            orderService.cancelOrder(orderId);</span><br><span class="line">            inventoryService.releaseInventory(orderId);</span><br><span class="line">            log.info(<span class="string">&quot;订单&#123;&#125;超时取消&quot;</span>, orderId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2️⃣-优惠券过期提醒"><a href="#2️⃣-优惠券过期提醒" class="headerlink" title="2️⃣ 优惠券过期提醒"></a>2️⃣ 优惠券过期提醒</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CouponReminderService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 优惠券到期提醒</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendCouponExpiryReminder</span><span class="params">(Long couponId, LocalDateTime expiryTime)</span> &#123;</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 过期前3天提醒</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">remind3Days</span> <span class="operator">=</span> expiryTime.minusDays(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">if</span> (remind3Days.isAfter(now)) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">delay3Days</span> <span class="operator">=</span> Duration.between(now, remind3Days).getSeconds();</span><br><span class="line">            delayMessageService.sendDelayMessage(</span><br><span class="line">                <span class="string">&quot;coupon.reminder.exchange&quot;</span>,</span><br><span class="line">                <span class="string">&quot;coupon.expire.3days&quot;</span>, </span><br><span class="line">                couponId, </span><br><span class="line">                (<span class="type">int</span>) delay3Days</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 过期前1天提醒</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">remind1Day</span> <span class="operator">=</span> expiryTime.minusDays(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (remind1Day.isAfter(now)) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">delay1Day</span> <span class="operator">=</span> Duration.between(now, remind1Day).getSeconds();</span><br><span class="line">            delayMessageService.sendDelayMessage(</span><br><span class="line">                <span class="string">&quot;coupon.reminder.exchange&quot;</span>,</span><br><span class="line">                <span class="string">&quot;coupon.expire.1day&quot;</span>, </span><br><span class="line">                couponId, </span><br><span class="line">                (<span class="type">int</span>) delay1Day</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;coupon.expire.3days.queue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleCoupon3DaysReminder</span><span class="params">(Long couponId)</span> &#123;</span><br><span class="line">        <span class="comment">// 发送3天到期提醒</span></span><br><span class="line">        notificationService.sendCouponExpiryReminder(couponId, <span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;coupon.expire.1day.queue&quot;)</span> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleCoupon1DayReminder</span><span class="params">(Long couponId)</span> &#123;</span><br><span class="line">        <span class="comment">// 发送1天到期提醒</span></span><br><span class="line">        notificationService.sendCouponExpiryReminder(couponId, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3️⃣-用户激活提醒"><a href="#3️⃣-用户激活提醒" class="headerlink" title="3️⃣ 用户激活提醒"></a>3️⃣ 用户激活提醒</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserActivationService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户注册后激活提醒</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendActivationReminders</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">        <span class="comment">// 24小时后首次提醒</span></span><br><span class="line">        delayMessageService.sendDelayMessage(</span><br><span class="line">            <span class="string">&quot;user.activation.exchange&quot;</span>,</span><br><span class="line">            <span class="string">&quot;activation.remind.1day&quot;</span>,</span><br><span class="line">            userId,</span><br><span class="line">            <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span></span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 72小时后二次提醒  </span></span><br><span class="line">        delayMessageService.sendDelayMessage(</span><br><span class="line">            <span class="string">&quot;user.activation.exchange&quot;</span>, </span><br><span class="line">            <span class="string">&quot;activation.remind.3days&quot;</span>,</span><br><span class="line">            userId,</span><br><span class="line">            <span class="number">72</span> * <span class="number">60</span> * <span class="number">60</span></span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 7天后最终提醒</span></span><br><span class="line">        delayMessageService.sendDelayMessage(</span><br><span class="line">            <span class="string">&quot;user.activation.exchange&quot;</span>,</span><br><span class="line">            <span class="string">&quot;activation.remind.7days&quot;</span>, </span><br><span class="line">            userId,</span><br><span class="line">            <span class="number">7</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;activation.remind.queue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleActivationReminder</span><span class="params">(Long userId, <span class="meta">@Header(&quot;x-death&quot;)</span> List&lt;Map&lt;String, Object&gt;&gt; xDeath)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(userId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (user != <span class="literal">null</span> &amp;&amp; !user.isActivated()) &#123;</span><br><span class="line">            <span class="comment">// 发送激活提醒邮件</span></span><br><span class="line">            emailService.sendActivationReminder(user.getEmail());</span><br><span class="line">            log.info(<span class="string">&quot;发送用户&#123;&#125;激活提醒&quot;</span>, userId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="🔄-分段延迟消息的高级模式"><a href="#🔄-分段延迟消息的高级模式" class="headerlink" title="🔄 分段延迟消息的高级模式"></a>🔄 分段延迟消息的高级模式</h3><h4 id="智能分段策略"><a href="#智能分段策略" class="headerlink" title="智能分段策略"></a>智能分段策略</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SmartDelayMessageService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送分段延迟消息，支持中途取消</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendSegmentedDelayTask</span><span class="params">(String taskId, <span class="type">int</span> totalMinutes)</span> &#123;</span><br><span class="line">        <span class="comment">// 分段策略：5分钟一段</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">segmentMinutes</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">segments</span> <span class="operator">=</span> totalMinutes / segmentMinutes;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= segments; i++) &#123;</span><br><span class="line">            <span class="type">DelayTaskMessage</span> <span class="variable">message</span> <span class="operator">=</span> DelayTaskMessage.builder()</span><br><span class="line">                    .taskId(taskId)</span><br><span class="line">                    .segment(i)</span><br><span class="line">                    .totalSegments(segments)</span><br><span class="line">                    .action(<span class="string">&quot;CHECK_TASK_STATUS&quot;</span>)</span><br><span class="line">                    .build();</span><br><span class="line">            </span><br><span class="line">            delayMessageService.sendDelayMessage(</span><br><span class="line">                <span class="string">&quot;task.delay.exchange&quot;</span>,</span><br><span class="line">                <span class="string">&quot;task.segment.check&quot;</span>, </span><br><span class="line">                message,</span><br><span class="line">                segmentMinutes * i * <span class="number">60</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 在Redis中标记任务状态</span></span><br><span class="line">        redisTemplate.opsForValue().set(</span><br><span class="line">            <span class="string">&quot;task:&quot;</span> + taskId + <span class="string">&quot;:status&quot;</span>, </span><br><span class="line">            <span class="string">&quot;RUNNING&quot;</span>,</span><br><span class="line">            Duration.ofMinutes(totalMinutes + <span class="number">10</span>)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        log.info(<span class="string">&quot;任务&#123;&#125;已创建，共&#123;&#125;段，每&#123;&#125;分钟检查一次&quot;</span>, taskId, segments, segmentMinutes);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 取消延迟任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cancelDelayTask</span><span class="params">(String taskId)</span> &#123;</span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;task:&quot;</span> + taskId + <span class="string">&quot;:status&quot;</span>, <span class="string">&quot;CANCELLED&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;任务&#123;&#125;已取消&quot;</span>, taskId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理分段延迟消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;task.segment.check.queue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleSegmentCheck</span><span class="params">(DelayTaskMessage message)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">taskId</span> <span class="operator">=</span> message.getTaskId();</span><br><span class="line">        <span class="type">String</span> <span class="variable">statusKey</span> <span class="operator">=</span> <span class="string">&quot;task:&quot;</span> + taskId + <span class="string">&quot;:status&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> (String) redisTemplate.opsForValue().get(statusKey);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查任务是否已取消或完成</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">&quot;RUNNING&quot;</span>.equals(status)) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;任务&#123;&#125;状态为&#123;&#125;，跳过段&#123;&#125;检查&quot;</span>, taskId, status, message.getSegment());</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 执行具体的检查逻辑</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">taskCompleted</span> <span class="operator">=</span> executeTaskCheck(taskId, message);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (taskCompleted) &#123;</span><br><span class="line">            redisTemplate.opsForValue().set(statusKey, <span class="string">&quot;COMPLETED&quot;</span>);</span><br><span class="line">            log.info(<span class="string">&quot;任务&#123;&#125;已完成&quot;</span>, taskId);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message.getSegment().equals(message.getTotalSegments())) &#123;</span><br><span class="line">            <span class="comment">// 最后一段，任务超时</span></span><br><span class="line">            redisTemplate.opsForValue().set(statusKey, <span class="string">&quot;TIMEOUT&quot;</span>);</span><br><span class="line">            handleTaskTimeout(taskId);</span><br><span class="line">            log.warn(<span class="string">&quot;任务&#123;&#125;执行超时&quot;</span>, taskId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">executeTaskCheck</span><span class="params">(String taskId, DelayTaskMessage message)</span> &#123;</span><br><span class="line">        <span class="comment">// 根据taskId和action执行具体的检查逻辑</span></span><br><span class="line">        <span class="keyword">switch</span> (message.getAction()) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;CHECK_TASK_STATUS&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> checkTaskStatus(taskId);</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;CHECK_PAYMENT_STATUS&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> checkPaymentStatus(taskId);</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="📊-延迟消息监控与告警"><a href="#📊-延迟消息监控与告警" class="headerlink" title="📊 延迟消息监控与告警"></a>📊 延迟消息监控与告警</h3><h4 id="监控指标配置"><a href="#监控指标配置" class="headerlink" title="监控指标配置"></a>监控指标配置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayMessageMonitor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter delayMessageSentCounter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Timer delayMessageProcessingTimer;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DelayMessageMonitor</span><span class="params">(MeterRegistry meterRegistry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.meterRegistry = meterRegistry;</span><br><span class="line">        <span class="built_in">this</span>.delayMessageSentCounter = Counter.builder(<span class="string">&quot;delay.message.sent&quot;</span>)</span><br><span class="line">                .description(<span class="string">&quot;延迟消息发送计数&quot;</span>)</span><br><span class="line">                .register(meterRegistry);</span><br><span class="line">        <span class="built_in">this</span>.delayMessageProcessingTimer = Timer.builder(<span class="string">&quot;delay.message.processing&quot;</span>)</span><br><span class="line">                .description(<span class="string">&quot;延迟消息处理时间&quot;</span>)</span><br><span class="line">                .register(meterRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录延迟消息发送</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordDelayMessageSent</span><span class="params">(String exchange, String routingKey, <span class="type">int</span> delaySeconds)</span> &#123;</span><br><span class="line">        delayMessageSentCounter.increment(</span><br><span class="line">            Tags.of(</span><br><span class="line">                <span class="string">&quot;exchange&quot;</span>, exchange,</span><br><span class="line">                <span class="string">&quot;routing_key&quot;</span>, routingKey,</span><br><span class="line">                <span class="string">&quot;delay_range&quot;</span>, getDelayRange(delaySeconds)</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录延迟消息处理时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordDelayMessageProcessing</span><span class="params">(String queue, Runnable task)</span> &#123;</span><br><span class="line">        Timer.<span class="type">Sample</span> <span class="variable">sample</span> <span class="operator">=</span> Timer.start(meterRegistry);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            task.run();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            sample.stop(delayMessageProcessingTimer.tag(<span class="string">&quot;queue&quot;</span>, queue));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getDelayRange</span><span class="params">(<span class="type">int</span> seconds)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (seconds &lt; <span class="number">60</span>) <span class="keyword">return</span> <span class="string">&quot;0-1min&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (seconds &lt; <span class="number">300</span>) <span class="keyword">return</span> <span class="string">&quot;1-5min&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (seconds &lt; <span class="number">1800</span>) <span class="keyword">return</span> <span class="string">&quot;5-30min&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (seconds &lt; <span class="number">3600</span>) <span class="keyword">return</span> <span class="string">&quot;30min-1h&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;1h+&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="🚨-延迟消息的注意事项"><a href="#🚨-延迟消息的注意事项" class="headerlink" title="🚨 延迟消息的注意事项"></a>🚨 延迟消息的注意事项</h3><h4 id="性能优化建议"><a href="#性能优化建议" class="headerlink" title="性能优化建议"></a>性能优化建议</h4><ol>
<li><strong>控制延迟时长</strong>：避免超过1小时的延迟</li>
<li><strong>分段处理</strong>：长任务分解为多个短延迟</li>
<li><strong>状态管理</strong>：使用Redis管理任务状态，支持取消</li>
<li><strong>监控告警</strong>：监控延迟消息的堆积情况</li>
<li><strong>幂等设计</strong>：确保重复消息的安全处理</li>
</ol>
<h4 id="故障处理方案"><a href="#故障处理方案" class="headerlink" title="故障处理方案"></a>故障处理方案</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayMessageFailureHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 延迟消息失败重试策略</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;delay.message.retry.queue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelayMessageRetry</span><span class="params">(DelayTaskMessage message, </span></span><br><span class="line"><span class="params">                                       <span class="meta">@Header</span> Map&lt;String, Object&gt; headers)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取重试次数</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">retryCount</span> <span class="operator">=</span> (Integer) headers.getOrDefault(<span class="string">&quot;x-retry-count&quot;</span>, <span class="number">0</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (retryCount &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">                <span class="comment">// 重试次数过多，转入人工处理队列</span></span><br><span class="line">                rabbitTemplate.convertAndSend(<span class="string">&quot;manual.process.exchange&quot;</span>, </span><br><span class="line">                                            <span class="string">&quot;delay.message.failed&quot;</span>, message);</span><br><span class="line">                log.error(<span class="string">&quot;延迟消息重试失败，转入人工处理：&#123;&#125;&quot;</span>, message);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 处理延迟消息</span></span><br><span class="line">            processDelayMessage(message);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;处理延迟消息失败，准备重试：&#123;&#125;&quot;</span>, message, e);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 增加重试次数并重新发送</span></span><br><span class="line">            headers.put(<span class="string">&quot;x-retry-count&quot;</span>, (Integer) headers.getOrDefault(<span class="string">&quot;x-retry-count&quot;</span>, <span class="number">0</span>) + <span class="number">1</span>);</span><br><span class="line">            </span><br><span class="line">            rabbitTemplate.convertAndSend(<span class="string">&quot;delay.message.retry.exchange&quot;</span>, </span><br><span class="line">                                        <span class="string">&quot;retry&quot;</span>, message, msg -&gt; &#123;</span><br><span class="line">                headers.forEach((key, value) -&gt; </span><br><span class="line">                    msg.getMessageProperties().getHeaders().put(key, value));</span><br><span class="line">                <span class="comment">// 重试延迟递增：2^retry_count 分钟</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">delayMinutes</span> <span class="operator">=</span> (<span class="type">int</span>) Math.pow(<span class="number">2</span>, (Integer) headers.get(<span class="string">&quot;x-retry-count&quot;</span>));</span><br><span class="line">                msg.getMessageProperties().setHeader(<span class="string">&quot;x-delay&quot;</span>, delayMinutes * <span class="number">60</span> * <span class="number">1000</span>);</span><br><span class="line">                <span class="keyword">return</span> msg;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">## <span class="number">4.5</span> 订单状态同步问题（实战案例）</span><br><span class="line"></span><br><span class="line">### 🎯 业务背景</span><br><span class="line"></span><br><span class="line">在交易服务中利用延迟消息实现订单支付状态同步，解决订单超时未支付的问题。</span><br><span class="line"></span><br><span class="line">#### 📋 优化思路分析</span><br><span class="line"></span><br><span class="line">**传统做法**：订单超时<span class="number">30</span>分钟，发送一条<span class="number">30</span>分钟延迟消息</span><br><span class="line">- ❌ **问题**：大多数用户<span class="number">1</span>分钟内支付，消息却要在MQ中停留<span class="number">30</span>分钟</span><br><span class="line">- ❌ **资源浪费**：长时间占用MQ资源</span><br><span class="line"></span><br><span class="line">**优化方案**：多次检测，而不是最后一刻才检测</span><br><span class="line">- ✅ **优点**：提前发现支付完成，取消后续检测</span><br><span class="line">- ✅ **节省资源**：避免长时间占用MQ</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**优化后的检测时间点**：</span><br><span class="line">- <span class="number">10</span>秒、<span class="number">20</span>秒、<span class="number">30</span>秒、<span class="number">45</span>秒、<span class="number">60</span>秒</span><br><span class="line">- <span class="number">1</span>分<span class="number">30</span>秒、<span class="number">2</span>分钟、<span class="number">5</span>分钟、<span class="number">10</span>分钟、<span class="number">30</span>分钟</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 📊 多延迟消息数据结构</span><br><span class="line"></span><br><span class="line">#### 通用多延迟消息实体</span><br><span class="line">```java</span><br><span class="line"><span class="keyword">package</span> com.hmall.common.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiDelayMessage</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息体</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录延迟时间的集合（毫秒）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Long&gt; delayMillis;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MultiDelayMessage</span><span class="params">(T data, List&lt;Long&gt; delayMillis)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.data = data;</span><br><span class="line">        <span class="built_in">this</span>.delayMillis = delayMillis;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 便捷构造方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; MultiDelayMessage&lt;T&gt; <span class="title function_">of</span><span class="params">(T data, Long... delayMillis)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MultiDelayMessage</span>&lt;&gt;(data, Arrays.asList(delayMillis));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取并移除下一个延迟时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">removeNextDelay</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> delayMillis.remove(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否还有下一个延迟时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasNextDelay</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> !delayMillis.isEmpty();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="🔧-系统集成配置"><a href="#🔧-系统集成配置" class="headerlink" title="🔧 系统集成配置"></a>🔧 系统集成配置</h3><h4 id="1）定义MQ常量"><a href="#1）定义MQ常量" class="headerlink" title="1）定义MQ常量"></a>1）定义MQ常量</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmall.trade.constants;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MqConstants</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">DELAY_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;trade.delay.topic&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">DELAY_ORDER_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;trade.order.delay.queue&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">DELAY_ORDER_ROUTING_KEY</span> <span class="operator">=</span> <span class="string">&quot;order.query&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2）抽取共享MQ配置"><a href="#2）抽取共享MQ配置" class="headerlink" title="2）抽取共享MQ配置"></a>2）抽取共享MQ配置</h4><p>在nacos中定义<code>shared-mq.yml</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">$&#123;hm.mq.host:192.168.150.101&#125;</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">$&#123;hm.mq.port:5672&#125;</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">$&#123;hm.mq.vhost:/hmall&#125;</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">$&#123;hm.mq.un:hmall&#125;</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">$&#123;hm.mq.pw:123&#125;</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">prefetch:</span> <span class="number">1</span> <span class="comment"># 每次只能获取一条消息，处理完成才能获取下一个消息</span></span><br></pre></td></tr></table></figure>

<h3 id="💼-业务实现"><a href="#💼-业务实现" class="headerlink" title="💼 业务实现"></a>💼 业务实现</h3><h4 id="1）改造下单业务"><a href="#1）改造下单业务" class="headerlink" title="1）改造下单业务"></a>1）改造下单业务</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">IOrderService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">createOrder</span><span class="params">(OrderFormDTO orderFormDTO)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 创建订单</span></span><br><span class="line">        <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> buildOrder(orderFormDTO);</span><br><span class="line">        save(order);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 清理购物车</span></span><br><span class="line">        clearCart(orderFormDTO.getCartIds());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 扣减库存</span></span><br><span class="line">        orderDetailService.reduceStock(order.getId(), orderFormDTO.getDetails());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. 发送延迟消息检查支付状态</span></span><br><span class="line">        sendOrderDelayMessage(order.getId());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> order.getId();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送订单延迟检查消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendOrderDelayMessage</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">        <span class="comment">// 定义检查时间点（秒）：10s, 30s, 60s, 5min, 15min, 30min</span></span><br><span class="line">        MultiDelayMessage&lt;Long&gt; message = MultiDelayMessage.of(</span><br><span class="line">            orderId,</span><br><span class="line">            <span class="number">10</span> * <span class="number">1000L</span>,      <span class="comment">// 10秒</span></span><br><span class="line">            <span class="number">30</span> * <span class="number">1000L</span>,      <span class="comment">// 30秒  </span></span><br><span class="line">            <span class="number">60</span> * <span class="number">1000L</span>,      <span class="comment">// 1分钟</span></span><br><span class="line">            <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000L</span>,  <span class="comment">// 5分钟</span></span><br><span class="line">            <span class="number">15</span> * <span class="number">60</span> * <span class="number">1000L</span>, <span class="comment">// 15分钟</span></span><br><span class="line">            <span class="number">30</span> * <span class="number">60</span> * <span class="number">1000L</span>  <span class="comment">// 30分钟</span></span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 发送第一次延迟消息</span></span><br><span class="line">        rabbitTemplate.convertAndSend(</span><br><span class="line">            MqConstants.DELAY_EXCHANGE,</span><br><span class="line">            MqConstants.DELAY_ORDER_ROUTING_KEY,</span><br><span class="line">            message,</span><br><span class="line">            msg -&gt; &#123;</span><br><span class="line">                msg.getMessageProperties().setHeader(<span class="string">&quot;x-delay&quot;</span>, message.removeNextDelay().intValue());</span><br><span class="line">                <span class="keyword">return</span> msg;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        log.info(<span class="string">&quot;订单&#123;&#125;延迟检查消息已发送&quot;</span>, orderId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2）支付状态查询接口"><a href="#2）支付状态查询接口" class="headerlink" title="2）支付状态查询接口"></a>2）支付状态查询接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PayClient.java</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;pay-service&quot;, fallbackFactory = PayClientFallback.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PayClient</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据交易订单id查询支付单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/pay-orders/biz/&#123;id&#125;&quot;)</span></span><br><span class="line">    PayOrderDTO <span class="title function_">queryPayOrderByBizOrderNo</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PayController.java - pay-service中实现</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/biz/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> PayOrderDTO <span class="title function_">queryPayOrderByBizOrderNo</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    <span class="type">PayOrder</span> <span class="variable">payOrder</span> <span class="operator">=</span> payOrderService.lambdaQuery()</span><br><span class="line">            .eq(PayOrder::getBizOrderNo, id)</span><br><span class="line">            .one();</span><br><span class="line">    <span class="keyword">return</span> BeanUtils.copyBean(payOrder, PayOrderDTO.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3）延迟消息监听器"><a href="#3）延迟消息监听器" class="headerlink" title="3）延迟消息监听器"></a>3）延迟消息监听器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderStatusListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IOrderService orderService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PayClient payClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">            value = @Queue(name = MqConstants.DELAY_ORDER_QUEUE, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">            exchange = @Exchange(name = MqConstants.DELAY_EXCHANGE, type = ExchangeTypes.TOPIC),</span></span><br><span class="line"><span class="meta">            key = MqConstants.DELAY_ORDER_ROUTING_KEY</span></span><br><span class="line"><span class="meta">    ))</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenOrderCheckDelayMessage</span><span class="params">(MultiDelayMessage&lt;Long&gt; msg)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 获取订单ID</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">orderId</span> <span class="operator">=</span> msg.getData();</span><br><span class="line">        log.info(<span class="string">&quot;开始检查订单&#123;&#125;的支付状态&quot;</span>, orderId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 查询订单状态</span></span><br><span class="line">        <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderService.getById(orderId);</span><br><span class="line">        <span class="keyword">if</span> (order == <span class="literal">null</span> || order.getStatus() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;订单&#123;&#125;不存在或已处理，跳过检查&quot;</span>, orderId);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 查询支付状态</span></span><br><span class="line">        <span class="type">PayOrderDTO</span> <span class="variable">payOrder</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            payOrder = payClient.queryPayOrderByBizOrderNo(orderId);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;查询订单&#123;&#125;支付状态失败&quot;</span>, orderId, e);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. 判断支付状态</span></span><br><span class="line">        <span class="keyword">if</span> (payOrder != <span class="literal">null</span> &amp;&amp; payOrder.getStatus() == <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="comment">// 支付成功，更新订单状态</span></span><br><span class="line">            orderService.markOrderPaySuccess(orderId);</span><br><span class="line">            log.info(<span class="string">&quot;订单&#123;&#125;支付成功，状态已更新&quot;</span>, orderId);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. 未支付，判断是否继续检查</span></span><br><span class="line">        <span class="keyword">if</span> (msg.hasNextDelay()) &#123;</span><br><span class="line">            <span class="comment">// 发送下一次延迟检查消息</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">nextDelay</span> <span class="operator">=</span> msg.removeNextDelay().intValue();</span><br><span class="line">            rabbitTemplate.convertAndSend(</span><br><span class="line">                MqConstants.DELAY_EXCHANGE, </span><br><span class="line">                MqConstants.DELAY_ORDER_ROUTING_KEY, </span><br><span class="line">                msg,</span><br><span class="line">                message -&gt; &#123;</span><br><span class="line">                    message.getMessageProperties().setHeader(<span class="string">&quot;x-delay&quot;</span>, nextDelay);</span><br><span class="line">                    <span class="keyword">return</span> message;</span><br><span class="line">                &#125;</span><br><span class="line">            );</span><br><span class="line">            log.info(<span class="string">&quot;订单&#123;&#125;将在&#123;&#125;秒后进行下次检查&quot;</span>, orderId, nextDelay / <span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 没有剩余检查时间，取消订单</span></span><br><span class="line">            orderService.cancelOrder(orderId);</span><br><span class="line">            log.warn(<span class="string">&quot;订单&#123;&#125;超时未支付，已取消&quot;</span>, orderId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="🔧-订单取消业务实现"><a href="#🔧-订单取消业务实现" class="headerlink" title="🔧 订单取消业务实现"></a>🔧 订单取消业务实现</h3><h4 id="取消订单方法"><a href="#取消订单方法" class="headerlink" title="取消订单方法"></a>取消订单方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cancelOrder</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 查询订单</span></span><br><span class="line">    <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> getById(orderId);</span><br><span class="line">    <span class="keyword">if</span> (order == <span class="literal">null</span>) &#123;</span><br><span class="line">        log.warn(<span class="string">&quot;订单&#123;&#125;不存在&quot;</span>, orderId);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 幂等性检查</span></span><br><span class="line">    <span class="keyword">if</span> (order.getStatus() != <span class="number">1</span>) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;订单&#123;&#125;状态为&#123;&#125;，不是未支付状态，跳过取消&quot;</span>, orderId, order.getStatus());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 更新订单状态为已取消</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">updated</span> <span class="operator">=</span> lambdaUpdate()</span><br><span class="line">            .set(Order::getStatus, <span class="number">5</span>) <span class="comment">// 5-已取消</span></span><br><span class="line">            .set(Order::getCloseTime, LocalDateTime.now())</span><br><span class="line">            .eq(Order::getId, orderId)</span><br><span class="line">            .eq(Order::getStatus, <span class="number">1</span>) <span class="comment">// 只有未支付状态才能取消</span></span><br><span class="line">            .update();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!updated) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;订单&#123;&#125;取消失败，可能状态已变更&quot;</span>, orderId);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. 恢复库存</span></span><br><span class="line">    restoreInventory(orderId);</span><br><span class="line">    </span><br><span class="line">    log.info(<span class="string">&quot;订单&#123;&#125;已成功取消并恢复库存&quot;</span>, orderId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 恢复库存</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">restoreInventory</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">    <span class="comment">// 查询订单详情</span></span><br><span class="line">    List&lt;OrderDetail&gt; details = orderDetailService.lambdaQuery()</span><br><span class="line">            .eq(OrderDetail::getOrderId, orderId)</span><br><span class="line">            .list();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 批量恢复库存</span></span><br><span class="line">    <span class="keyword">for</span> (OrderDetail detail : details) &#123;</span><br><span class="line">        inventoryService.restoreStock(detail.getItemId(), detail.getNum());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="📊-完整方案总结"><a href="#📊-完整方案总结" class="headerlink" title="📊 完整方案总结"></a>📊 完整方案总结</h3><h4 id="🔄-工作流程-2"><a href="#🔄-工作流程-2" class="headerlink" title="🔄 工作流程"></a>🔄 工作流程</h4><pre class="mermaid">graph TD
    A[用户下单] --> B[创建订单]
    B --> C[发送第1次延迟消息 10s]
    C --> D{10s后检查}
    D -->|已支付| E[更新订单状态]
    D -->|未支付| F[发送第2次延迟消息 30s]
    F --> G{30s后检查}
    G -->|已支付| E
    G -->|未支付| H[继续后续检查...]
    H --> I{30分钟后最终检查}
    I -->|已支付| E
    I -->|未支付| J[取消订单并恢复库存]</pre>

<h4 id="📈-性能优化效果"><a href="#📈-性能优化效果" class="headerlink" title="📈 性能优化效果"></a>📈 性能优化效果</h4><table>
<thead>
<tr>
<th>指标</th>
<th>传统方案</th>
<th>优化方案</th>
<th>改善效果</th>
</tr>
</thead>
<tbody><tr>
<td><strong>平均延迟消息存活时间</strong></td>
<td>30分钟</td>
<td>~1分钟</td>
<td>降低96%</td>
</tr>
<tr>
<td><strong>MQ资源占用</strong></td>
<td>高</td>
<td>低</td>
<td>显著降低</td>
</tr>
<tr>
<td><strong>支付状态检测实时性</strong></td>
<td>低</td>
<td>高</td>
<td>显著提升</td>
</tr>
<tr>
<td><strong>用户体验</strong></td>
<td>一般</td>
<td>优秀</td>
<td>明显改善</td>
</tr>
</tbody></table>
<h4 id="🎯-方案优势"><a href="#🎯-方案优势" class="headerlink" title="🎯 方案优势"></a>🎯 方案优势</h4><ol>
<li><strong>资源节省</strong>：大部分消息在1分钟内完成，避免长时间占用MQ</li>
<li><strong>实时性强</strong>：多次检查提高支付状态更新的实时性</li>
<li><strong>用户体验好</strong>：支付后快速反馈，无需等待</li>
<li><strong>系统稳定</strong>：分段检查降低系统压力</li>
<li><strong>易于扩展</strong>：可根据业务需求调整检查时间点</li>
</ol>
<p>这种设计既保证了业务需求，又优化了系统性能，是延迟消息在实际业务中的最佳实践。</p>
<hr>
<h2 id="🎯-本章总结"><a href="#🎯-本章总结" class="headerlink" title="🎯 本章总结"></a>🎯 本章总结</h2><h3 id="📚-核心知识回顾"><a href="#📚-核心知识回顾" class="headerlink" title="📚 核心知识回顾"></a>📚 核心知识回顾</h3><h4 id="1️⃣-生产者可靠性机制"><a href="#1️⃣-生产者可靠性机制" class="headerlink" title="1️⃣ 生产者可靠性机制"></a>1️⃣ 生产者可靠性机制</h4><ul>
<li><strong>生产者确认机制</strong>：确保消息成功到达MQ</li>
<li><strong>生产者重试机制</strong>：网络故障时自动重试</li>
<li><strong>生产者确认回调</strong>：实时感知发送结果</li>
</ul>
<h4 id="2️⃣-MQ可靠性保障"><a href="#2️⃣-MQ可靠性保障" class="headerlink" title="2️⃣ MQ可靠性保障"></a>2️⃣ MQ可靠性保障</h4><ul>
<li><strong>数据持久化</strong>：Exchange、Queue、Message三重持久化</li>
<li><strong>LazyQueue机制</strong>：内存+磁盘混合存储，提升性能</li>
<li><strong>集群容错</strong>：多节点保障高可用</li>
</ul>
<h4 id="3️⃣-消费者可靠性策略"><a href="#3️⃣-消费者可靠性策略" class="headerlink" title="3️⃣ 消费者可靠性策略"></a>3️⃣ 消费者可靠性策略</h4><ul>
<li><strong>消费者确认机制</strong>：manual模式精确控制</li>
<li><strong>消费者重试机制</strong>：本地重试+失败策略</li>
<li><strong>消费者限流</strong>：prefetch控制并发度</li>
</ul>
<h4 id="4️⃣-延迟消息实现"><a href="#4️⃣-延迟消息实现" class="headerlink" title="4️⃣ 延迟消息实现"></a>4️⃣ 延迟消息实现</h4><ul>
<li><strong>DelayExchange插件</strong>：官方推荐方案</li>
<li><strong>死信+TTL组合</strong>：传统实现方式</li>
<li><strong>业务场景应用</strong>：订单超时、定时任务</li>
</ul>
<h3 id="🛡️-可靠性最佳实践"><a href="#🛡️-可靠性最佳实践" class="headerlink" title="🛡️ 可靠性最佳实践"></a>🛡️ 可靠性最佳实践</h3><h4 id="🔄-完整可靠性架构"><a href="#🔄-完整可靠性架构" class="headerlink" title="🔄 完整可靠性架构"></a>🔄 完整可靠性架构</h4><pre class="mermaid">graph TD
    A[业务服务] -->|发送消息| B[RabbitMQ Broker]
    B -->|确认回调| A
    B -->|持久化存储| C[磁盘存储]
    B -->|消息投递| D[消费者服务]
    D -->|消费确认| B
    D -->|处理失败| E[重试机制]
    E -->|超出重试次数| F[失败队列]
    F -->|人工干预| G[补偿处理]</pre>

<h4 id="📋-可靠性配置清单"><a href="#📋-可靠性配置清单" class="headerlink" title="📋 可靠性配置清单"></a>📋 可靠性配置清单</h4><table>
<thead>
<tr>
<th>环节</th>
<th>配置项</th>
<th>推荐值</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><strong>生产者</strong></td>
<td>publisher-confirm-type</td>
<td>correlated</td>
<td>开启确认机制</td>
</tr>
<tr>
<td></td>
<td>publisher-returns</td>
<td>true</td>
<td>开启退回机制</td>
</tr>
<tr>
<td></td>
<td>template.mandatory</td>
<td>true</td>
<td>强制路由</td>
</tr>
<tr>
<td><strong>MQ</strong></td>
<td>durable</td>
<td>true</td>
<td>交换机持久化</td>
</tr>
<tr>
<td></td>
<td>durable</td>
<td>true</td>
<td>队列持久化</td>
</tr>
<tr>
<td></td>
<td>deliveryMode</td>
<td>2</td>
<td>消息持久化</td>
</tr>
<tr>
<td><strong>消费者</strong></td>
<td>acknowledge-mode</td>
<td>manual</td>
<td>手动确认</td>
</tr>
<tr>
<td></td>
<td>prefetch</td>
<td>1</td>
<td>限流控制</td>
</tr>
<tr>
<td></td>
<td>retry.enabled</td>
<td>true</td>
<td>开启重试</td>
</tr>
</tbody></table>
<h3 id="⚡-性能优化策略"><a href="#⚡-性能优化策略" class="headerlink" title="⚡ 性能优化策略"></a>⚡ 性能优化策略</h3><h4 id="📊-性能对比分析"><a href="#📊-性能对比分析" class="headerlink" title="📊 性能对比分析"></a>📊 性能对比分析</h4><table>
<thead>
<tr>
<th>优化方案</th>
<th>吞吐量提升</th>
<th>延迟降低</th>
<th>资源节省</th>
</tr>
</thead>
<tbody><tr>
<td><strong>LazyQueue</strong></td>
<td>30-50%</td>
<td>20-30%</td>
<td>60-80%</td>
</tr>
<tr>
<td><strong>批量发送</strong></td>
<td>200-300%</td>
<td>-</td>
<td>40-60%</td>
</tr>
<tr>
<td><strong>合理prefetch</strong></td>
<td>100-200%</td>
<td>50-70%</td>
<td>30-50%</td>
</tr>
<tr>
<td><strong>连接池优化</strong></td>
<td>50-100%</td>
<td>30-50%</td>
<td>20-40%</td>
</tr>
</tbody></table>
<h4 id="🚀-高性能配置"><a href="#🚀-高性能配置" class="headerlink" title="🚀 高性能配置"></a>🚀 高性能配置</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="comment"># 连接池配置</span></span><br><span class="line">    <span class="attr">cache:</span></span><br><span class="line">      <span class="attr">connection:</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">channel</span></span><br><span class="line">        <span class="attr">size:</span> <span class="number">10</span></span><br><span class="line">    <span class="comment"># 生产者配置  </span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">retry:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">max-attempts:</span> <span class="number">3</span></span><br><span class="line">    <span class="comment"># 消费者配置</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">prefetch:</span> <span class="number">10</span>        <span class="comment"># 根据处理能力调整</span></span><br><span class="line">        <span class="attr">concurrency:</span> <span class="number">2</span>      <span class="comment"># 并发消费者数量</span></span><br><span class="line">        <span class="attr">max-concurrency:</span> <span class="number">10</span> <span class="comment"># 最大并发数</span></span><br></pre></td></tr></table></figure>

<h3 id="🔧-故障排查指南"><a href="#🔧-故障排查指南" class="headerlink" title="🔧 故障排查指南"></a>🔧 故障排查指南</h3><h4 id="🚨-常见问题诊断"><a href="#🚨-常见问题诊断" class="headerlink" title="🚨 常见问题诊断"></a>🚨 常见问题诊断</h4><ol>
<li><p><strong>消息丢失排查</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查队列消息积压</span></span><br><span class="line">rabbitmqctl list_queues name messages</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查交换机绑定</span></span><br><span class="line">rabbitmqctl list_bindings</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看连接状态</span></span><br><span class="line">rabbitmqctl list_connections</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>性能问题分析</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 监控队列状态</span></span><br><span class="line">rabbitmqctl list_queues name messages_ready messages_unacknowledged</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看消费者状态</span></span><br><span class="line">rabbitmqctl list_consumers</span><br><span class="line"></span><br><span class="line"><span class="comment"># 监控内存使用</span></span><br><span class="line">rabbitmq-diagnostics memory_breakdown</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>重试机制验证</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 日志中查看重试记录</span></span><br><span class="line"><span class="number">2024</span>-<span class="number">01</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">30</span>:<span class="number">00</span> WARN  Retrying message delivery, attempt: <span class="number">2</span>/<span class="number">3</span></span><br><span class="line"><span class="number">2024</span>-<span class="number">01</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">30</span>:<span class="number">05</span> ERROR Message delivery failed after <span class="number">3</span> attempts, sending to DLQ</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="📈-监控与告警"><a href="#📈-监控与告警" class="headerlink" title="📈 监控与告警"></a>📈 监控与告警</h3><h4 id="📊-关键指标监控"><a href="#📊-关键指标监控" class="headerlink" title="📊 关键指标监控"></a>📊 关键指标监控</h4><pre class="mermaid">graph LR
    A[RabbitMQ监控] --> B[队列指标]
    A --> C[连接指标] 
    A --> D[节点指标]
    A --> E[业务指标]
    
    B --> B1[消息堆积]
    B --> B2[消费速率]
    B --> B3[确认延迟]
    
    C --> C1[连接数量]
    C --> C2[信道数量]
    C --> C3[连接状态]
    
    D --> D1[内存使用]
    D --> D2[磁盘使用]
    D --> D3[CPU使用率]
    
    E --> E1[业务成功率]
    E --> E2[处理延迟]
    E --> E3[错误率]</pre>

<h4 id="⚠️-告警规则配置"><a href="#⚠️-告警规则配置" class="headerlink" title="⚠️ 告警规则配置"></a>⚠️ 告警规则配置</h4><table>
<thead>
<tr>
<th>指标</th>
<th>告警阈值</th>
<th>级别</th>
<th>处理建议</th>
</tr>
</thead>
<tbody><tr>
<td><strong>队列消息堆积</strong></td>
<td>&gt; 1000条</td>
<td>WARNING</td>
<td>检查消费者状态</td>
</tr>
<tr>
<td><strong>消息堆积</strong></td>
<td>&gt; 10000条</td>
<td>CRITICAL</td>
<td>立即扩容消费者</td>
</tr>
<tr>
<td><strong>消费延迟</strong></td>
<td>&gt; 5秒</td>
<td>WARNING</td>
<td>优化处理逻辑</td>
</tr>
<tr>
<td><strong>错误率</strong></td>
<td>&gt; 5%</td>
<td>CRITICAL</td>
<td>检查业务逻辑</td>
</tr>
<tr>
<td><strong>连接数</strong></td>
<td>&gt; 80%最大值</td>
<td>WARNING</td>
<td>优化连接池</td>
</tr>
</tbody></table>
<h3 id="🎯-实战应用场景"><a href="#🎯-实战应用场景" class="headerlink" title="🎯 实战应用场景"></a>🎯 实战应用场景</h3><h4 id="💼-典型业务场景"><a href="#💼-典型业务场景" class="headerlink" title="💼 典型业务场景"></a>💼 典型业务场景</h4><ol>
<li><p><strong>订单系统</strong></p>
<ul>
<li>订单超时取消（延迟消息）</li>
<li>库存扣减确认（可靠性保证）</li>
<li>支付状态同步（重试机制）</li>
</ul>
</li>
<li><p><strong>用户系统</strong></p>
<ul>
<li>注册邮件发送（异步处理）</li>
<li>密码重置通知（可靠投递）</li>
<li>用户行为分析（数据收集）</li>
</ul>
</li>
<li><p><strong>物流系统</strong></p>
<ul>
<li>配送状态更新（实时同步）</li>
<li>异常订单处理（失败重试）</li>
<li>运费计算通知（延迟处理）</li>
</ul>
</li>
</ol>
<h4 id="🏗️-架构设计模式"><a href="#🏗️-架构设计模式" class="headerlink" title="🏗️ 架构设计模式"></a>🏗️ 架构设计模式</h4><pre class="mermaid">graph TD
    A[前端应用] --> B[API网关]
    B --> C[业务服务集群]
    C --> D[RabbitMQ集群]
    D --> E[消费者服务集群]
    E --> F[数据存储层]
    
    D --> G[监控告警系统]
    G --> H[运维平台]
    
    style D fill:#e1f5fe
    style E fill:#f3e5f5
    style G fill:#fff3e0</pre>

<h3 id="📝-开发规范建议"><a href="#📝-开发规范建议" class="headerlink" title="📝 开发规范建议"></a>📝 开发规范建议</h3><h4 id="✅-编码最佳实践"><a href="#✅-编码最佳实践" class="headerlink" title="✅ 编码最佳实践"></a>✅ 编码最佳实践</h4><ol>
<li><p><strong>消息设计原则</strong></p>
<ul>
<li>消息体尽量小巧，避免大对象传输</li>
<li>使用合适的序列化方式（JSON&#x2F;Protobuf）</li>
<li>设计幂等性消息处理逻辑</li>
</ul>
</li>
<li><p><strong>异常处理策略</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;business.queue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(BusinessMessage msg)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 业务处理逻辑</span></span><br><span class="line">        businessService.process(msg);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (BusinessException e) &#123;</span><br><span class="line">        <span class="comment">// 业务异常，记录日志，不重试</span></span><br><span class="line">        log.error(<span class="string">&quot;Business error: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AmqpRejectAndDontRequeueException</span>(e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// 系统异常，可以重试</span></span><br><span class="line">        log.error(<span class="string">&quot;System error: &#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>性能优化建议</strong></p>
<ul>
<li>合理设置prefetch值</li>
<li>使用LazyQueue减少内存占用</li>
<li>批量处理提升吞吐量</li>
<li>连接池复用减少开销</li>
</ul>
</li>
</ol>
<h3 id="🔮-技术发展趋势"><a href="#🔮-技术发展趋势" class="headerlink" title="🔮 技术发展趋势"></a>🔮 技术发展趋势</h3><h4 id="🌟-新特性展望"><a href="#🌟-新特性展望" class="headerlink" title="🌟 新特性展望"></a>🌟 新特性展望</h4><ol>
<li><strong>Quorum队列</strong>：更强的一致性保证</li>
<li><strong>Stream队列</strong>：流式数据处理支持</li>
<li><strong>插件生态</strong>：更丰富的功能扩展</li>
<li><strong>云原生支持</strong>：Kubernetes原生集成</li>
</ol>
<h4 id="🎓-持续学习路径"><a href="#🎓-持续学习路径" class="headerlink" title="🎓 持续学习路径"></a>🎓 持续学习路径</h4><ol>
<li><strong>深入原理</strong>：AMQP协议、Erlang&#x2F;OTP平台</li>
<li><strong>高级特性</strong>：Federation、Shovel、插件开发</li>
<li><strong>运维实践</strong>：集群管理、性能调优、故障处理</li>
<li><strong>生态集成</strong>：Spring Cloud Stream、Kafka对比</li>
</ol>
<hr>
<p>通过本章的学习，你已经掌握了RabbitMQ高级特性的核心知识。在实际项目中，请根据业务需求选择合适的可靠性策略，并持续监控和优化系统性能。记住，<strong>可靠性和性能往往需要权衡，选择最适合业务场景的方案才是最好的方案</strong>。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://cxhahalala.github.io">Cx</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://cxhahalala.github.io/posts/mq/rabbitMq-high/">https://cxhahalala.github.io/posts/mq/rabbitMq-high/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://cxhahalala.github.io" target="_blank">Cx`s Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/RabbitMQ/">RabbitMQ</a><a class="post-meta__tags" href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a><a class="post-meta__tags" href="/tags/Spring-AMQP/">Spring AMQP</a></div><div class="post-share"><div class="social-share" data-image="https://w.wallhaven.cc/full/je/wallhaven-je8q9w.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/posts/mq/rabbitMq-base/" title="RabbitMq-基础知识"><img class="cover" src="https://w.wallhaven.cc/full/3q/wallhaven-3qod59.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">RabbitMq-基础知识</div></div><div class="info-2"><div class="info-item-1">RabbitMQ 快速入门指南1. 为什么需要消息队列 (MQ)？在现代微服务架构中，服务间的通信至关重要。传统的同步调用（如 Feign）虽然直观，但存在一些问题：   性能瓶颈：调用方必须等待服务方响应，链路上的任何延迟都会累积，影响整体性能。 耦合度高：服务之间紧密依赖，一个服务的变更可能需要修改多个相关服务。 级联失败：如果一个服务出现故障，依赖它的所有上游服务都可能失败，导致“雪崩效应”。  异步消息队列 (MQ) 提供了一种解决方案。它允许服务之间通过发送和接收消息进行通信，而无需直接相互调用。 异步调用的优势：  服务解耦：消息的发送者和接收者没有直接依赖，可以独立开发、部署和扩展。 提升性能：发送方将消息放入队列后即可返回，无需等待处理结果，提高了系统吞吐量。 故障隔离：单个服务的暂时性故障不会影响其他服务，消息会暂存在队列中，待服务恢复后继续处理。 削峰填谷：可以平滑处理突发流量，防止系统因瞬时请求过载而崩溃。   2. RabbitMQ 核心概念与安装2.1 MQ...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/mq/rabbitMq-base/" title="RabbitMq-基础知识"><img class="cover" src="https://w.wallhaven.cc/full/3q/wallhaven-3qod59.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-12</div><div class="info-item-2">RabbitMq-基础知识</div></div><div class="info-2"><div class="info-item-1">RabbitMQ 快速入门指南1. 为什么需要消息队列 (MQ)？在现代微服务架构中，服务间的通信至关重要。传统的同步调用（如 Feign）虽然直观，但存在一些问题：   性能瓶颈：调用方必须等待服务方响应，链路上的任何延迟都会累积，影响整体性能。 耦合度高：服务之间紧密依赖，一个服务的变更可能需要修改多个相关服务。 级联失败：如果一个服务出现故障，依赖它的所有上游服务都可能失败，导致“雪崩效应”。  异步消息队列 (MQ) 提供了一种解决方案。它允许服务之间通过发送和接收消息进行通信，而无需直接相互调用。 异步调用的优势：  服务解耦：消息的发送者和接收者没有直接依赖，可以独立开发、部署和扩展。 提升性能：发送方将消息放入队列后即可返回，无需等待处理结果，提高了系统吞吐量。 故障隔离：单个服务的暂时性故障不会影响其他服务，消息会暂存在队列中，待服务恢复后继续处理。 削峰填谷：可以平滑处理突发流量，防止系统因瞬时请求过载而崩溃。   2. RabbitMQ 核心概念与安装2.1 MQ...</div></div></div></a><a class="pagination-related" href="/posts/redis/redis-message-queue/" title="Redis消息队列"><img class="cover" src="https://w.wallhaven.cc/full/3q/wallhaven-3qod59.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-06-11</div><div class="info-item-2">Redis消息队列</div></div><div class="info-2"><div class="info-item-1">Redis消息队列详解：介绍了Redis实现消息队列的三种方式 - List、PubSub和Stream。重点讲解了Stream的ACK确认机制、消费者组模式，以及如何通过Java代码实现通用的异步消息处理系统。Stream方式具备消息可回溯、多消费者支持、阻塞读取和消息确认等特性，是生产环境的推荐选择。  Redis消息队列什么是消息队列什么是消息队列：字面意思就是存放消息的队列。最简单的消息队列模型包括3个角色：  消息队列：存储和管理消息，也被称为消息代理（Message Broker） 生产者：发送消息到消息队列 消费者：从消息队列获取消息并处理消息  使用队列的好处在于解耦：以快递配送为例，快递员（生产者）将快递放入快递柜（消息队列），用户（消费者）随时从快递柜取货。这种异步处理方式避免了快递员等待用户在家的时间浪费。 在秒杀场景中：用户下单后，系统快速校验条件并将订单信息发送到消息队列，后台服务异步处理订单，既实现了系统解耦，又提升了响应速度。 Redis 作为消息队列的优势：虽然有 Kafka、RabbitMQ 等专业 MQ 中间件，但如果项目中已使用...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7-%E5%8F%AF%E9%9D%A0%E6%80%A7%E4%B8%8E%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF"><span class="toc-number">1.</span> <span class="toc-text">RabbitMQ 高级特性 - 可靠性与延迟消息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9C%9F%E5%AE%9E%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF"><span class="toc-number">1.1.1.</span> <span class="toc-text">真实业务场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.2.</span> <span class="toc-text">核心问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E5%8F%91%E9%80%81%E8%80%85%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%80%A7"><span class="toc-number">2.</span> <span class="toc-text">1. 发送者的可靠性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E6%B6%88%E6%81%AF%E4%B8%A2%E5%A4%B1%E7%9A%84%E5%8F%AF%E8%83%BD%E6%80%A7%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">1.1 消息丢失的可能性分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%94%8D-%E6%B6%88%E6%81%AF%E4%B8%A2%E5%A4%B1%E7%9A%84%E4%B8%89%E5%A4%A7%E7%8E%AF%E8%8A%82"><span class="toc-number">2.1.1.</span> <span class="toc-text">🔍 消息丢失的三大环节</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%B8%8F%E2%83%A3-%E5%8F%91%E9%80%81%E9%98%B6%E6%AE%B5%E4%B8%A2%E5%A4%B1"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">1️⃣ 发送阶段丢失</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%B8%8F%E2%83%A3-MQ%E5%AD%98%E5%82%A8%E9%98%B6%E6%AE%B5%E4%B8%A2%E5%A4%B1"><span class="toc-number">2.1.1.2.</span> <span class="toc-text">2️⃣ MQ存储阶段丢失</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%EF%B8%8F%E2%83%A3-%E6%B6%88%E8%B4%B9%E9%98%B6%E6%AE%B5%E4%B8%A2%E5%A4%B1"><span class="toc-number">2.1.1.3.</span> <span class="toc-text">3️⃣ 消费阶段丢失</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%93%8B-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%A7%88"><span class="toc-number">2.1.2.</span> <span class="toc-text">📋 解决方案概览</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E7%94%9F%E4%BA%A7%E8%80%85%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6"><span class="toc-number">2.2.</span> <span class="toc-text">1.2 生产者重试机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8E%AF-%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">2.2.1.</span> <span class="toc-text">🎯 适用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9A%99%EF%B8%8F-%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F"><span class="toc-number">2.2.2.</span> <span class="toc-text">⚙️ 配置方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%A7%AA-%E6%B5%8B%E8%AF%95%E6%95%88%E6%9E%9C"><span class="toc-number">2.2.3.</span> <span class="toc-text">🧪 测试效果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9A%A0%EF%B8%8F-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">2.2.4.</span> <span class="toc-text">⚠️ 注意事项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%92%A1-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">2.2.5.</span> <span class="toc-text">💡 最佳实践</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E7%94%9F%E4%BA%A7%E8%80%85%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6"><span class="toc-number">2.3.</span> <span class="toc-text">1.3 生产者确认机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8E%AF-%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98"><span class="toc-number">2.3.1.</span> <span class="toc-text">🎯 解决问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%93%8B-%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.3.2.</span> <span class="toc-text">📋 确认机制类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%94%84-%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">2.3.3.</span> <span class="toc-text">🔄 工作流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E5%88%86%E6%9E%90"><span class="toc-number">2.3.3.1.</span> <span class="toc-text">场景分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-%E5%AE%9E%E7%8E%B0%E7%94%9F%E4%BA%A7%E8%80%85%E7%A1%AE%E8%AE%A4"><span class="toc-number">2.4.</span> <span class="toc-text">1.4 实现生产者确认</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-1-%E5%BC%80%E5%90%AF%E7%94%9F%E4%BA%A7%E8%80%85%E7%A1%AE%E8%AE%A4"><span class="toc-number">2.4.1.</span> <span class="toc-text">1.4.1 开启生产者确认</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%8B-confirm%E7%B1%BB%E5%9E%8B%E8%AF%B4%E6%98%8E"><span class="toc-number">2.4.1.1.</span> <span class="toc-text">📋 confirm类型说明</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-2-%E5%AE%9A%E4%B9%89ReturnCallback"><span class="toc-number">2.4.2.</span> <span class="toc-text">1.4.2 定义ReturnCallback</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-3-%E5%AE%9A%E4%B9%89ConfirmCallback"><span class="toc-number">2.4.3.</span> <span class="toc-text">1.4.3 定义ConfirmCallback</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%92%A1-%E4%BD%BF%E7%94%A8CorrelationData"><span class="toc-number">2.4.3.1.</span> <span class="toc-text">💡 使用CorrelationData</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%9D-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.4.3.2.</span> <span class="toc-text">📝 代码示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%A7%AA-%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C"><span class="toc-number">2.4.4.</span> <span class="toc-text">🧪 测试结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%93%8A-%E7%BB%93%E6%9E%9C%E5%88%86%E6%9E%90"><span class="toc-number">2.4.5.</span> <span class="toc-text">📊 结果分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9A%A0%EF%B8%8F-%E4%BD%BF%E7%94%A8%E5%BB%BA%E8%AE%AE"><span class="toc-number">2.4.6.</span> <span class="toc-text">⚠️ 使用建议</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-MQ%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%80%A7"><span class="toc-number">3.</span> <span class="toc-text">2. MQ的可靠性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">3.1.</span> <span class="toc-text">2.1 数据持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8E%AF-%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-number">3.1.1.</span> <span class="toc-text">🎯 问题分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%92%BE-%E4%B8%89%E7%BA%A7%E6%8C%81%E4%B9%85%E5%8C%96%E7%AD%96%E7%95%A5"><span class="toc-number">3.1.2.</span> <span class="toc-text">💾 三级持久化策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">3.1.3.</span> <span class="toc-text">2.1.1 交换机持久化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-%E9%98%9F%E5%88%97%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">3.1.4.</span> <span class="toc-text">2.1.2 队列持久化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-3-%E6%B6%88%E6%81%AF%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">3.1.5.</span> <span class="toc-text">2.1.3 消息持久化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%93%9D-%E4%BB%A3%E7%A0%81%E4%B8%AD%E7%9A%84%E6%8C%81%E4%B9%85%E5%8C%96%E9%85%8D%E7%BD%AE"><span class="toc-number">3.1.6.</span> <span class="toc-text">📝 代码中的持久化配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9A%A0%EF%B8%8F-%E9%87%8D%E8%A6%81%E6%8F%90%E9%86%92"><span class="toc-number">3.1.7.</span> <span class="toc-text">⚠️ 重要提醒</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-LazyQueue%EF%BC%88%E6%83%B0%E6%80%A7%E9%98%9F%E5%88%97%EF%BC%89"><span class="toc-number">3.2.</span> <span class="toc-text">2.2 LazyQueue（惰性队列）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8E%AF-%E8%83%8C%E6%99%AF%E9%97%AE%E9%A2%98"><span class="toc-number">3.2.1.</span> <span class="toc-text">🎯 背景问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%8A-%E6%B6%88%E6%81%AF%E7%A7%AF%E5%8E%8B%E7%9A%84%E5%9C%BA%E6%99%AF"><span class="toc-number">3.2.1.1.</span> <span class="toc-text">📊 消息积压的场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9A%A0%EF%B8%8F-%E7%A7%AF%E5%8E%8B%E7%9A%84%E5%8D%B1%E5%AE%B3"><span class="toc-number">3.2.1.2.</span> <span class="toc-text">⚠️ 积压的危害</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%92%A1-LazyQueue%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">3.2.2.</span> <span class="toc-text">💡 LazyQueue解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%94%84-%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%E5%AF%B9%E6%AF%94"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">🔄 工作模式对比</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%88-%E7%89%88%E6%9C%AC%E6%BC%94%E8%BF%9B"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">📈 版本演进</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-%E6%8E%A7%E5%88%B6%E5%8F%B0%E9%85%8D%E7%BD%AELazy%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.2.3.</span> <span class="toc-text">2.2.1 控制台配置Lazy模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-%E4%BB%A3%E7%A0%81%E9%85%8D%E7%BD%AELazy%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.2.4.</span> <span class="toc-text">2.2.2 代码配置Lazy模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%B8%80%EF%BC%9AQueueBuilder%E6%96%B9%E5%BC%8F"><span class="toc-number">3.2.4.1.</span> <span class="toc-text">方式一：QueueBuilder方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%BA%8C%EF%BC%9A%E6%B3%A8%E8%A7%A3%E6%96%B9%E5%BC%8F"><span class="toc-number">3.2.4.2.</span> <span class="toc-text">方式二：注解方式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-%E6%9B%B4%E6%96%B0%E5%B7%B2%E6%9C%89%E9%98%9F%E5%88%97%E4%B8%BALazy%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.2.5.</span> <span class="toc-text">2.2.3 更新已有队列为Lazy模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%96%B9%E5%BC%8F"><span class="toc-number">3.2.5.1.</span> <span class="toc-text">命令行方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%8F%B0%E6%96%B9%E5%BC%8F"><span class="toc-number">3.2.5.2.</span> <span class="toc-text">控制台方式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8E%AF-%E4%BD%BF%E7%94%A8%E5%BB%BA%E8%AE%AE"><span class="toc-number">3.2.6.</span> <span class="toc-text">🎯 使用建议</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">3.2.6.1.</span> <span class="toc-text">适用场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E6%9D%83%E8%A1%A1"><span class="toc-number">3.2.6.2.</span> <span class="toc-text">性能权衡</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E6%B6%88%E8%B4%B9%E8%80%85%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%80%A7"><span class="toc-number">4.</span> <span class="toc-text">3. 消费者的可靠性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%9A%A8-%E5%B8%B8%E8%A7%81%E6%B6%88%E8%B4%B9%E6%95%85%E9%9A%9C"><span class="toc-number">4.0.1.</span> <span class="toc-text">🚨 常见消费故障</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9D%93-%E6%A0%B8%E5%BF%83%E9%97%AE%E9%A2%98"><span class="toc-number">4.0.2.</span> <span class="toc-text">❓ 核心问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E6%B6%88%E8%B4%B9%E8%80%85%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6"><span class="toc-number">4.1.</span> <span class="toc-text">3.1 消费者确认机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%94%84-%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86"><span class="toc-number">4.1.1.</span> <span class="toc-text">🔄 确认机制原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%8B-%E4%B8%89%E7%A7%8D%E5%9B%9E%E6%89%A7%E7%B1%BB%E5%9E%8B"><span class="toc-number">4.1.1.1.</span> <span class="toc-text">📋 三种回执类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%92%AD-%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">4.1.1.2.</span> <span class="toc-text">💭 使用场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9A%99%EF%B8%8F-SpringAMQP%E7%9A%84ACK%E5%A4%84%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.1.2.</span> <span class="toc-text">⚙️ SpringAMQP的ACK处理模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%8A-%E6%A8%A1%E5%BC%8F%E5%AF%B9%E6%AF%94"><span class="toc-number">4.1.2.1.</span> <span class="toc-text">📊 模式对比</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%A4%96-auto%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91"><span class="toc-number">4.1.2.2.</span> <span class="toc-text">🤖 auto模式的处理逻辑</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%8B-%E8%BF%94%E5%9B%9Ereject%E7%9A%84%E5%BC%82%E5%B8%B8%E7%B1%BB%E5%9E%8B"><span class="toc-number">4.1.2.3.</span> <span class="toc-text">📋 返回reject的异常类型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%9B%A0%EF%B8%8F-%E9%85%8D%E7%BD%AE%E6%B6%88%E8%B4%B9%E8%80%85%E7%A1%AE%E8%AE%A4%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.1.3.</span> <span class="toc-text">🛠️ 配置消费者确认模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%A7%AA-%E6%B5%8B%E8%AF%95%E4%B8%8D%E5%90%8C%E7%A1%AE%E8%AE%A4%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.1.4.</span> <span class="toc-text">🧪 测试不同确认模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95none%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.1.4.1.</span> <span class="toc-text">测试none模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95auto%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.1.4.2.</span> <span class="toc-text">测试auto模式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E5%A4%B1%E8%B4%A5%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6"><span class="toc-number">4.2.</span> <span class="toc-text">3.2 失败重试机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8E%AF-%E9%97%AE%E9%A2%98%E5%9C%BA%E6%99%AF"><span class="toc-number">4.2.1.</span> <span class="toc-text">🎯 问题场景</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9A%A0%EF%B8%8F-%E6%97%A0%E9%99%90%E5%BE%AA%E7%8E%AF%E7%9A%84%E5%8D%B1%E5%AE%B3"><span class="toc-number">4.2.1.1.</span> <span class="toc-text">⚠️ 无限循环的危害</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%92%A1-%E6%9C%AC%E5%9C%B0%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6"><span class="toc-number">4.2.2.</span> <span class="toc-text">💡 本地重试机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9A%99%EF%B8%8F-%E9%85%8D%E7%BD%AE%E6%9C%AC%E5%9C%B0%E9%87%8D%E8%AF%95"><span class="toc-number">4.2.3.</span> <span class="toc-text">⚙️ 配置本地重试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%8A-%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E"><span class="toc-number">4.2.3.1.</span> <span class="toc-text">📊 参数说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%94%84-stateless%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3"><span class="toc-number">4.2.3.2.</span> <span class="toc-text">🔄 stateless参数详解</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%A7%AA-%E6%B5%8B%E8%AF%95%E9%87%8D%E8%AF%95%E6%95%88%E6%9E%9C"><span class="toc-number">4.2.4.</span> <span class="toc-text">🧪 测试重试效果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%93%8A-%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6%E5%AF%B9%E6%AF%94"><span class="toc-number">4.2.5.</span> <span class="toc-text">📊 重试机制对比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%94%84-%E9%87%8D%E8%AF%95%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">4.2.6.</span> <span class="toc-text">🔄 重试流程图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9A%A0%EF%B8%8F-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9-1"><span class="toc-number">4.2.7.</span> <span class="toc-text">⚠️ 注意事项</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E5%A4%B1%E8%B4%A5%E5%A4%84%E7%90%86%E7%AD%96%E7%95%A5"><span class="toc-number">4.3.</span> <span class="toc-text">3.3 失败处理策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8E%AF-%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-1"><span class="toc-number">4.3.1.</span> <span class="toc-text">🎯 问题分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%92%A1-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">4.3.2.</span> <span class="toc-text">💡 解决方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%93%8B-%E4%B8%89%E7%A7%8D%E5%A4%84%E7%90%86%E7%AD%96%E7%95%A5"><span class="toc-number">4.3.3.</span> <span class="toc-text">📋 三种处理策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8F%86-%E6%8E%A8%E8%8D%90%E6%96%B9%E6%A1%88%EF%BC%9ARepublishMessageRecoverer"><span class="toc-number">4.3.4.</span> <span class="toc-text">🏆 推荐方案：RepublishMessageRecoverer</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%94%A7-%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4"><span class="toc-number">4.3.4.1.</span> <span class="toc-text">🔧 实现步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8E%AF-%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E"><span class="toc-number">4.3.4.2.</span> <span class="toc-text">🎯 配置说明</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%A7%AA-%E6%B5%8B%E8%AF%95%E6%95%88%E6%9E%9C-1"><span class="toc-number">4.3.5.</span> <span class="toc-text">🧪 测试效果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%94%84-%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">4.3.6.</span> <span class="toc-text">🔄 处理流程图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%9B%A0%EF%B8%8F-%E5%BC%82%E5%B8%B8%E6%B6%88%E6%81%AF%E7%9A%84%E5%A4%84%E7%90%86"><span class="toc-number">4.3.7.</span> <span class="toc-text">🛠️ 异常消息的处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%B8%80%EF%BC%9A%E4%BA%BA%E5%B7%A5%E5%A4%84%E7%90%86"><span class="toc-number">4.3.7.1.</span> <span class="toc-text">方式一：人工处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%BA%8C%EF%BC%9A%E7%9B%91%E5%90%AC%E5%BC%82%E5%B8%B8%E9%98%9F%E5%88%97"><span class="toc-number">4.3.7.2.</span> <span class="toc-text">方式二：监听异常队列</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%93%8A-%E5%90%84%E7%A7%8D%E7%AD%96%E7%95%A5%E5%AF%B9%E6%AF%94"><span class="toc-number">4.3.8.</span> <span class="toc-text">📊 各种策略对比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%92%A1-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-1"><span class="toc-number">4.3.9.</span> <span class="toc-text">💡 最佳实践</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-%E4%B8%9A%E5%8A%A1%E5%B9%82%E7%AD%89%E6%80%A7"><span class="toc-number">4.4.</span> <span class="toc-text">3.4 业务幂等性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8E%AF-%E4%BB%80%E4%B9%88%E6%98%AF%E5%B9%82%E7%AD%89%E6%80%A7%EF%BC%9F"><span class="toc-number">4.4.1.</span> <span class="toc-text">🎯 什么是幂等性？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%8A-%E5%B9%82%E7%AD%89-vs-%E9%9D%9E%E5%B9%82%E7%AD%89%E6%93%8D%E4%BD%9C"><span class="toc-number">4.4.1.1.</span> <span class="toc-text">📊 幂等 vs 非幂等操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%9A%A8-%E9%87%8D%E5%A4%8D%E6%89%A7%E8%A1%8C%E7%9A%84%E4%B8%9A%E5%8A%A1%E9%A3%8E%E9%99%A9"><span class="toc-number">4.4.2.</span> <span class="toc-text">🚨 重复执行的业务风险</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%92%B0-%E7%94%B5%E5%95%86%E5%9C%BA%E6%99%AF%E7%A4%BA%E4%BE%8B"><span class="toc-number">4.4.2.1.</span> <span class="toc-text">💰 电商场景示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%94%84-%E6%B6%88%E6%81%AF%E9%87%8D%E5%A4%8D%E6%8A%95%E9%80%92%E7%9A%84%E5%9C%BA%E6%99%AF"><span class="toc-number">4.4.3.</span> <span class="toc-text">🔄 消息重复投递的场景</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%8B-%E5%B8%B8%E8%A7%81%E5%9C%BA%E6%99%AF"><span class="toc-number">4.4.3.1.</span> <span class="toc-text">📋 常见场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8E%AD-%E5%85%B7%E4%BD%93%E6%A1%88%E4%BE%8B%EF%BC%9A%E6%94%AF%E4%BB%98%E7%8A%B6%E6%80%81%E6%9B%B4%E6%96%B0"><span class="toc-number">4.4.3.2.</span> <span class="toc-text">🎭 具体案例：支付状态更新</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%92%A1-%E5%B9%82%E7%AD%89%E6%80%A7%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">4.4.4.</span> <span class="toc-text">💡 幂等性解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%B8%80%EF%BC%9A%E5%94%AF%E4%B8%80%E6%B6%88%E6%81%AFID"><span class="toc-number">4.4.4.1.</span> <span class="toc-text">方案一：唯一消息ID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%BA%8C%EF%BC%9A%E4%B8%9A%E5%8A%A1%E7%8A%B6%E6%80%81%E5%88%A4%E6%96%AD%EF%BC%88%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="toc-number">4.4.4.2.</span> <span class="toc-text">方案二：业务状态判断（推荐）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%93%8A-%E4%B8%A4%E7%A7%8D%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94"><span class="toc-number">4.4.5.</span> <span class="toc-text">📊 两种方案对比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8F%86-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">4.4.6.</span> <span class="toc-text">🏆 最佳实践</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-%E5%85%9C%E5%BA%95%E6%96%B9%E6%A1%88"><span class="toc-number">4.5.</span> <span class="toc-text">3.5 兜底方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8E%AF-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%85%9C%E5%BA%95%E6%96%B9%E6%A1%88%EF%BC%9F"><span class="toc-number">4.5.1.</span> <span class="toc-text">🎯 为什么需要兜底方案？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%92%A1-%E4%B8%BB%E5%8A%A8%E6%9F%A5%E8%AF%A2%E5%85%9C%E5%BA%95"><span class="toc-number">4.5.2.</span> <span class="toc-text">💡 主动查询兜底</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%94%84-%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">4.5.2.1.</span> <span class="toc-text">🔄 完整流程图</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%8F%B0-%E5%AE%9A%E6%97%B6%E6%9F%A5%E8%AF%A2%E7%AD%96%E7%95%A5"><span class="toc-number">4.5.3.</span> <span class="toc-text">⏰ 定时查询策略</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%A4%94-%E4%BD%95%E6%97%B6%E6%9F%A5%E8%AF%A2%EF%BC%9F"><span class="toc-number">4.5.3.1.</span> <span class="toc-text">🤔 何时查询？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%92%A1-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%9A%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="toc-number">4.5.3.2.</span> <span class="toc-text">💡 解决方案：定时任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%8B-%E5%AE%9E%E7%8E%B0%E7%A4%BA%E4%BE%8B"><span class="toc-number">4.5.3.3.</span> <span class="toc-text">📋 实现示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%94%84-%E5%8F%8C%E9%87%8D%E4%BF%9D%E9%9A%9C%E6%9C%BA%E5%88%B6"><span class="toc-number">4.5.4.</span> <span class="toc-text">🔄 双重保障机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%8A-%E4%BF%9D%E9%9A%9C%E7%AD%96%E7%95%A5%E5%AF%B9%E6%AF%94"><span class="toc-number">4.5.4.1.</span> <span class="toc-text">📊 保障策略对比</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8F%86-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E7%BB%84%E5%90%88"><span class="toc-number">4.5.4.2.</span> <span class="toc-text">🏆 最佳实践组合</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9A%99%EF%B8%8F-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E4%BC%98%E5%8C%96"><span class="toc-number">4.5.5.</span> <span class="toc-text">⚙️ 定时任务优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%88-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5"><span class="toc-number">4.5.5.1.</span> <span class="toc-text">📈 性能优化策略</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%93%8A-%E5%AE%8C%E6%95%B4%E5%8F%AF%E9%9D%A0%E6%80%A7%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93"><span class="toc-number">4.5.6.</span> <span class="toc-text">📊 完整可靠性方案总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8E%AF-%E6%96%B9%E6%A1%88%E9%80%89%E6%8B%A9%E5%BB%BA%E8%AE%AE"><span class="toc-number">4.5.7.</span> <span class="toc-text">🎯 方案选择建议</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%8A-%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF%E5%8C%B9%E9%85%8D"><span class="toc-number">4.5.7.1.</span> <span class="toc-text">📊 业务场景匹配</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF"><span class="toc-number">5.</span> <span class="toc-text">4. 延迟消息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">5.1.</span> <span class="toc-text">4.1 延迟消息的应用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%93%B1-%E7%94%B5%E5%95%86%E6%94%AF%E4%BB%98%E8%B6%85%E6%97%B6%E5%9C%BA%E6%99%AF"><span class="toc-number">5.1.1.</span> <span class="toc-text">📱 电商支付超时场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%92%A1-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%9A%E5%BB%B6%E8%BF%9F%E4%BB%BB%E5%8A%A1"><span class="toc-number">5.1.2.</span> <span class="toc-text">💡 解决方案：延迟任务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8E%AF-%E5%85%B8%E5%9E%8B%E5%9C%BA%E6%99%AF"><span class="toc-number">5.1.2.1.</span> <span class="toc-text">🎯 典型场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9D%93-%E6%8A%80%E6%9C%AF%E6%8C%91%E6%88%98"><span class="toc-number">5.1.3.</span> <span class="toc-text">❓ 技术挑战</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%94%A7-RabbitMQ%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E6%96%B9%E6%A1%88"><span class="toc-number">5.1.4.</span> <span class="toc-text">🔧 RabbitMQ延迟消息方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E6%AD%BB%E4%BF%A1%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%92%8C%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF"><span class="toc-number">5.2.</span> <span class="toc-text">4.2 死信交换机和延迟消息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-%E6%AD%BB%E4%BF%A1%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">5.2.1.</span> <span class="toc-text">4.2.1 死信交换机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8E%AF-%E4%BB%80%E4%B9%88%E6%98%AF%E6%AD%BB%E4%BF%A1%EF%BC%9F"><span class="toc-number">5.2.1.1.</span> <span class="toc-text">🎯 什么是死信？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%94%84-%E6%AD%BB%E4%BF%A1%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">5.2.1.2.</span> <span class="toc-text">🔄 死信交换机工作原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%8B-%E6%AD%BB%E4%BF%A1%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">5.2.1.3.</span> <span class="toc-text">📋 死信交换机的作用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.2.2.</span> <span class="toc-text">4.2.2 延迟消息实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8F%97%EF%B8%8F-%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.2.2.1.</span> <span class="toc-text">🏗️ 系统架构设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%94%84-%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B-1"><span class="toc-number">5.2.2.2.</span> <span class="toc-text">🔄 工作流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8E%AF-%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C"><span class="toc-number">5.2.2.3.</span> <span class="toc-text">🎯 实现效果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-3-%E6%AD%BB%E4%BF%A1-TTL%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93"><span class="toc-number">5.2.3.</span> <span class="toc-text">4.2.3 死信+TTL方案总结</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9C%85-%E4%BC%98%E7%82%B9"><span class="toc-number">5.2.3.1.</span> <span class="toc-text">✅ 优点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9D%8C-%E7%BC%BA%E7%82%B9"><span class="toc-number">5.2.3.2.</span> <span class="toc-text">❌ 缺点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%8A-%E5%9C%BA%E6%99%AF%E5%88%86%E6%9E%90"><span class="toc-number">5.2.3.3.</span> <span class="toc-text">📊 场景分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%92%A1-%E4%BD%BF%E7%94%A8%E5%BB%BA%E8%AE%AE"><span class="toc-number">5.2.3.4.</span> <span class="toc-text">💡 使用建议</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-DelayExchange%E6%8F%92%E4%BB%B6%EF%BC%88%E6%8E%A8%E8%8D%90%E6%96%B9%E6%A1%88%EF%BC%89"><span class="toc-number">5.3.</span> <span class="toc-text">4.3 DelayExchange插件（推荐方案）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8E%AF-%E6%8F%92%E4%BB%B6%E4%BC%98%E5%8A%BF"><span class="toc-number">5.3.1.</span> <span class="toc-text">🎯 插件优势</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%8A-%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94"><span class="toc-number">5.3.1.1.</span> <span class="toc-text">📊 方案对比</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%94%84-%E5%BB%B6%E8%BF%9F%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6"><span class="toc-number">5.3.2.</span> <span class="toc-text">🔄 延迟交换机工作机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%86%9A-%E4%B8%89%E7%A7%8D%E6%B5%81%E7%A8%8B%E5%AF%B9%E6%AF%94"><span class="toc-number">5.3.2.1.</span> <span class="toc-text">🆚 三种流程对比</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8E%AF-%E6%A0%B8%E5%BF%83%E5%8C%BA%E5%88%AB"><span class="toc-number">5.3.2.2.</span> <span class="toc-text">🎯 核心区别</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-%E6%8F%92%E4%BB%B6%E4%B8%8B%E8%BD%BD%E4%B8%8E%E5%AE%89%E8%A3%85"><span class="toc-number">5.3.3.</span> <span class="toc-text">4.3.1 插件下载与安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%A5-%E4%B8%8B%E8%BD%BD%E6%8F%92%E4%BB%B6"><span class="toc-number">5.3.3.1.</span> <span class="toc-text">📥 下载插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9A%99%EF%B8%8F-%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4"><span class="toc-number">5.3.3.2.</span> <span class="toc-text">⚙️ 安装步骤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-2-%E5%A3%B0%E6%98%8E%E5%BB%B6%E8%BF%9F%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">5.3.4.</span> <span class="toc-text">4.3.2 声明延迟交换机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8E%AF-%E9%87%8D%E8%A6%81%E5%8E%9F%E5%88%99"><span class="toc-number">5.3.4.1.</span> <span class="toc-text">🎯 重要原则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%9D-%E6%96%B9%E5%BC%8F%E4%B8%80%EF%BC%9A%E5%9F%BA%E4%BA%8E%E6%B3%A8%E8%A7%A3"><span class="toc-number">5.3.4.2.</span> <span class="toc-text">📝 方式一：基于注解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%9D-%E6%96%B9%E5%BC%8F%E4%BA%8C%EF%BC%9A%E5%9F%BA%E4%BA%8E-Bean%E9%85%8D%E7%BD%AE"><span class="toc-number">5.3.4.3.</span> <span class="toc-text">📝 方式二：基于@Bean配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-3-%E5%8F%91%E9%80%81%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF"><span class="toc-number">5.3.5.</span> <span class="toc-text">4.3.3 发送延迟消息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%94%91-%E6%A0%B8%E5%BF%83%E8%A6%81%E7%82%B9"><span class="toc-number">5.3.5.1.</span> <span class="toc-text">🔑 核心要点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%9D-%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95"><span class="toc-number">5.3.5.2.</span> <span class="toc-text">📝 基础用法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%94%A7-MessagePostProcessor%E8%AF%B4%E6%98%8E"><span class="toc-number">5.3.5.3.</span> <span class="toc-text">🔧 MessagePostProcessor说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%8B-%E5%AE%9E%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">5.3.5.4.</span> <span class="toc-text">📋 实用示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9A%A0%EF%B8%8F-%E9%87%8D%E8%A6%81%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">5.3.6.</span> <span class="toc-text">⚠️ 重要注意事项</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%9A%A8-%E6%80%A7%E8%83%BD%E8%AD%A6%E5%91%8A"><span class="toc-number">5.3.6.1.</span> <span class="toc-text">🚨 性能警告</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%92%A1-%E4%BD%BF%E7%94%A8%E5%BB%BA%E8%AE%AE-1"><span class="toc-number">5.3.6.2.</span> <span class="toc-text">💡 使用建议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%94%84-%E9%95%BF%E5%BB%B6%E8%BF%9F%E6%9B%BF%E4%BB%A3%E6%96%B9%E6%A1%88"><span class="toc-number">5.3.6.3.</span> <span class="toc-text">🔄 长延迟替代方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8E%AF-%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">5.3.7.</span> <span class="toc-text">🎯 延迟消息最佳实践</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">5.4.</span> <span class="toc-text">4.4 延迟消息实际应用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%93%B1-%E5%B8%B8%E8%A7%81%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF"><span class="toc-number">5.4.1.</span> <span class="toc-text">📱 常见业务场景</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%B8%8F%E2%83%A3-%E7%94%B5%E5%95%86%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86"><span class="toc-number">5.4.1.1.</span> <span class="toc-text">1️⃣ 电商订单管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%B8%8F%E2%83%A3-%E4%BC%98%E6%83%A0%E5%88%B8%E8%BF%87%E6%9C%9F%E6%8F%90%E9%86%92"><span class="toc-number">5.4.1.2.</span> <span class="toc-text">2️⃣ 优惠券过期提醒</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%EF%B8%8F%E2%83%A3-%E7%94%A8%E6%88%B7%E6%BF%80%E6%B4%BB%E6%8F%90%E9%86%92"><span class="toc-number">5.4.1.3.</span> <span class="toc-text">3️⃣ 用户激活提醒</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%94%84-%E5%88%86%E6%AE%B5%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E7%9A%84%E9%AB%98%E7%BA%A7%E6%A8%A1%E5%BC%8F"><span class="toc-number">5.4.2.</span> <span class="toc-text">🔄 分段延迟消息的高级模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%99%BA%E8%83%BD%E5%88%86%E6%AE%B5%E7%AD%96%E7%95%A5"><span class="toc-number">5.4.2.1.</span> <span class="toc-text">智能分段策略</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%93%8A-%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%91%8A%E8%AD%A6"><span class="toc-number">5.4.3.</span> <span class="toc-text">📊 延迟消息监控与告警</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E6%8C%87%E6%A0%87%E9%85%8D%E7%BD%AE"><span class="toc-number">5.4.3.1.</span> <span class="toc-text">监控指标配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%9A%A8-%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">5.4.4.</span> <span class="toc-text">🚨 延迟消息的注意事项</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE"><span class="toc-number">5.4.4.1.</span> <span class="toc-text">性能优化建议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86%E6%96%B9%E6%A1%88"><span class="toc-number">5.4.4.2.</span> <span class="toc-text">故障处理方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%94%A7-%E7%B3%BB%E7%BB%9F%E9%9B%86%E6%88%90%E9%85%8D%E7%BD%AE"><span class="toc-number">5.4.5.</span> <span class="toc-text">🔧 系统集成配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E5%AE%9A%E4%B9%89MQ%E5%B8%B8%E9%87%8F"><span class="toc-number">5.4.5.1.</span> <span class="toc-text">1）定义MQ常量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E6%8A%BD%E5%8F%96%E5%85%B1%E4%BA%ABMQ%E9%85%8D%E7%BD%AE"><span class="toc-number">5.4.5.2.</span> <span class="toc-text">2）抽取共享MQ配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%92%BC-%E4%B8%9A%E5%8A%A1%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.4.6.</span> <span class="toc-text">💼 业务实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E6%94%B9%E9%80%A0%E4%B8%8B%E5%8D%95%E4%B8%9A%E5%8A%A1"><span class="toc-number">5.4.6.1.</span> <span class="toc-text">1）改造下单业务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E6%94%AF%E4%BB%98%E7%8A%B6%E6%80%81%E6%9F%A5%E8%AF%A2%E6%8E%A5%E5%8F%A3"><span class="toc-number">5.4.6.2.</span> <span class="toc-text">2）支付状态查询接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%EF%BC%89%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E7%9B%91%E5%90%AC%E5%99%A8"><span class="toc-number">5.4.6.3.</span> <span class="toc-text">3）延迟消息监听器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%94%A7-%E8%AE%A2%E5%8D%95%E5%8F%96%E6%B6%88%E4%B8%9A%E5%8A%A1%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.4.7.</span> <span class="toc-text">🔧 订单取消业务实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%96%E6%B6%88%E8%AE%A2%E5%8D%95%E6%96%B9%E6%B3%95"><span class="toc-number">5.4.7.1.</span> <span class="toc-text">取消订单方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%93%8A-%E5%AE%8C%E6%95%B4%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93"><span class="toc-number">5.4.8.</span> <span class="toc-text">📊 完整方案总结</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%94%84-%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B-2"><span class="toc-number">5.4.8.1.</span> <span class="toc-text">🔄 工作流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%88-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%95%88%E6%9E%9C"><span class="toc-number">5.4.8.2.</span> <span class="toc-text">📈 性能优化效果</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8E%AF-%E6%96%B9%E6%A1%88%E4%BC%98%E5%8A%BF"><span class="toc-number">5.4.8.3.</span> <span class="toc-text">🎯 方案优势</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%AF-%E6%9C%AC%E7%AB%A0%E6%80%BB%E7%BB%93"><span class="toc-number">5.5.</span> <span class="toc-text">🎯 本章总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%93%9A-%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86%E5%9B%9E%E9%A1%BE"><span class="toc-number">5.5.1.</span> <span class="toc-text">📚 核心知识回顾</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%B8%8F%E2%83%A3-%E7%94%9F%E4%BA%A7%E8%80%85%E5%8F%AF%E9%9D%A0%E6%80%A7%E6%9C%BA%E5%88%B6"><span class="toc-number">5.5.1.1.</span> <span class="toc-text">1️⃣ 生产者可靠性机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%B8%8F%E2%83%A3-MQ%E5%8F%AF%E9%9D%A0%E6%80%A7%E4%BF%9D%E9%9A%9C"><span class="toc-number">5.5.1.2.</span> <span class="toc-text">2️⃣ MQ可靠性保障</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%EF%B8%8F%E2%83%A3-%E6%B6%88%E8%B4%B9%E8%80%85%E5%8F%AF%E9%9D%A0%E6%80%A7%E7%AD%96%E7%95%A5"><span class="toc-number">5.5.1.3.</span> <span class="toc-text">3️⃣ 消费者可靠性策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%EF%B8%8F%E2%83%A3-%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.5.1.4.</span> <span class="toc-text">4️⃣ 延迟消息实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%9B%A1%EF%B8%8F-%E5%8F%AF%E9%9D%A0%E6%80%A7%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">5.5.2.</span> <span class="toc-text">🛡️ 可靠性最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%94%84-%E5%AE%8C%E6%95%B4%E5%8F%AF%E9%9D%A0%E6%80%A7%E6%9E%B6%E6%9E%84"><span class="toc-number">5.5.2.1.</span> <span class="toc-text">🔄 完整可靠性架构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%8B-%E5%8F%AF%E9%9D%A0%E6%80%A7%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95"><span class="toc-number">5.5.2.2.</span> <span class="toc-text">📋 可靠性配置清单</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9A%A1-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5"><span class="toc-number">5.5.3.</span> <span class="toc-text">⚡ 性能优化策略</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%8A-%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94%E5%88%86%E6%9E%90"><span class="toc-number">5.5.3.1.</span> <span class="toc-text">📊 性能对比分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%9A%80-%E9%AB%98%E6%80%A7%E8%83%BD%E9%85%8D%E7%BD%AE"><span class="toc-number">5.5.3.2.</span> <span class="toc-text">🚀 高性能配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%94%A7-%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5%E6%8C%87%E5%8D%97"><span class="toc-number">5.5.4.</span> <span class="toc-text">🔧 故障排查指南</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%9A%A8-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%AF%8A%E6%96%AD"><span class="toc-number">5.5.4.1.</span> <span class="toc-text">🚨 常见问题诊断</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%93%88-%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%91%8A%E8%AD%A6"><span class="toc-number">5.5.5.</span> <span class="toc-text">📈 监控与告警</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%8A-%E5%85%B3%E9%94%AE%E6%8C%87%E6%A0%87%E7%9B%91%E6%8E%A7"><span class="toc-number">5.5.5.1.</span> <span class="toc-text">📊 关键指标监控</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9A%A0%EF%B8%8F-%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99%E9%85%8D%E7%BD%AE"><span class="toc-number">5.5.5.2.</span> <span class="toc-text">⚠️ 告警规则配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8E%AF-%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">5.5.6.</span> <span class="toc-text">🎯 实战应用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%92%BC-%E5%85%B8%E5%9E%8B%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF"><span class="toc-number">5.5.6.1.</span> <span class="toc-text">💼 典型业务场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8F%97%EF%B8%8F-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F"><span class="toc-number">5.5.6.2.</span> <span class="toc-text">🏗️ 架构设计模式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%93%9D-%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83%E5%BB%BA%E8%AE%AE"><span class="toc-number">5.5.7.</span> <span class="toc-text">📝 开发规范建议</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9C%85-%E7%BC%96%E7%A0%81%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">5.5.7.1.</span> <span class="toc-text">✅ 编码最佳实践</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%94%AE-%E6%8A%80%E6%9C%AF%E5%8F%91%E5%B1%95%E8%B6%8B%E5%8A%BF"><span class="toc-number">5.5.8.</span> <span class="toc-text">🔮 技术发展趋势</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8C%9F-%E6%96%B0%E7%89%B9%E6%80%A7%E5%B1%95%E6%9C%9B"><span class="toc-number">5.5.8.1.</span> <span class="toc-text">🌟 新特性展望</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8E%93-%E6%8C%81%E7%BB%AD%E5%AD%A6%E4%B9%A0%E8%B7%AF%E5%BE%84"><span class="toc-number">5.5.8.2.</span> <span class="toc-text">🎓 持续学习路径</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url(https://w.wallhaven.cc/full/je/wallhaven-je8q9w.jpg);"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By Cx</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div></body></html>